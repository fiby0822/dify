# Difyコーディングルール改善案

## 改善が必要な箇所と改善案

### 1. コンポーネント記述ルール_WEB検索.txt の改善

#### 現在の問題点
- 必須フィールド（provider_name、tool_label）の記載漏れ
- tool_configurationsセクションの扱いが不明確（オプション扱いだが実際は必須）
- tool_parametersの記述方法が実際の動作環境と異なる

#### 改善案

**必須パラメータセクションを以下に修正：**

```yaml
■必須パラメータ

1. provider_id: "langgenius/tavily/tavily"
   - 固定値として必須

2. provider_type: "builtin"
   - 固定値として必須

3. tool_name: "tavily_search"
   - 固定値として必須

4. provider_name: "langgenius/tavily/tavily"  # 新規追加
   - 固定値として必須
   - provider_idと同じ値を設定

5. tool_label: "Tavily Search"  # 新規追加
   - 固定値として必須
   - ツールの表示名

6. tool_configurations:  # 必須に変更
   - 必須セクション
   - 検索パラメータの設定値を記載
   - boolean値は0/1形式で記載

7. tool_parameters.query:
   - type: "mixed"
   - value: 検索クエリ（通常は {{#sys.query#}} などの変数参照）
   - 必須パラメータ
   - 注意：queryのみをtool_parametersに記載

8. is_team_authorization: true
   - チーム認証が必要
```

**使用例セクションを以下に修正：**

```yaml
■使用例

```yaml
- data:
    provider_id: langgenius/tavily/tavily
    provider_type: builtin
    tool_name: tavily_search
    provider_name: langgenius/tavily/tavily  # 必須
    tool_label: Tavily Search  # 必須
    is_team_authorization: true
    tool_parameters:
      query:
        type: mixed
        value: '{{#sys.query#}}'
    tool_configurations:  # 必須セクション
      search_depth: basic
      topic: general
      max_results: 5
      include_answer: 0  # boolean値は0/1形式
      include_images: 0
      include_raw_content: 0
    desc: "WEB検索を実行"
    selected: false
    title: "Tavily Search"
    type: tool
```

### 2. 全体コーディングルール.md の改善

#### 追加すべき内容

**セクション4.8 toolノード（外部ツール）に以下を追加：**

```markdown
#### 4.8.1 必須フィールドの完全性（最重要）
toolノードでは以下のフィールドがすべて必須です：
- provider_id
- provider_type
- tool_name
- **provider_name**（provider_idと同じ値）
- **tool_label**（ツールの表示名）
- is_team_authorization
- tool_parameters（queryのみ記載）
- **tool_configurations**（その他のパラメータはここに記載）

#### 4.8.2 パラメータの記載ルール
- **queryパラメータ**: tool_parametersセクションに{type: mixed, value: ...}形式で記載
- **その他のパラメータ**: tool_configurationsセクションに記載
- **boolean値**: tool_configurationsでは0/1形式で記載（true→1、false→0）
- **直接値指定は禁止**: tool_parametersに文字列や数値を直接指定しない
```

### 3. 品質チェックリスト.md の改善

#### セクション4.8に以下のチェック項目を追加：

```markdown
### 4.8 toolノード（外部ツール）
- [ ] provider_id、provider_type、tool_nameが正確に設定されている
- [ ] **provider_nameが設定されている（provider_idと同じ値）**
- [ ] **tool_labelが設定されている（ツールの表示名）**
- [ ] tool_parametersの必須項目がすべて設定されている
- [ ] **tool_parametersにはqueryパラメータのみ記載されている**
- [ ] **その他のパラメータはtool_configurationsに記載されている**
- [ ] **tool_configurationsのboolean値が0/1形式で記載されている**
- [ ] dependenciesセクションに対応するプラグイン定義がある
- [ ] is_team_authorizationが適切に設定されている
- [ ] エラーハンドリングが実装されている
- [ ] 外部API制限（レート制限等）を考慮している
```

### 4. クラッシュ事項チェックリスト.md の改善

#### セクション13に以下を追加：

```markdown
## 13. toolノード関連のクラッシュ防止

### 13.1 依存関係の確認
- [ ] **マーケットプレイスツールの場合、dependenciesが必須**
- [ ] **marketplace_plugin_unique_identifierが完全一致**
- [ ] **バージョン情報を含む完全な識別子を使用**

### 13.2 必須フィールドの確認
- [ ] **provider_nameフィールドが存在する（クラッシュの原因）**
- [ ] **tool_labelフィールドが存在する（クラッシュの原因）**
- [ ] **tool_configurationsセクションが存在する（クラッシュの原因）**

### 13.3 パラメータ形式の確認
- [ ] **tool_parametersに直接値を記載していない（文字列、数値、boolean）**
- [ ] **queryパラメータが{type: mixed, value: ...}形式**
- [ ] **tool_configurationsのboolean値が0/1形式**
```

### 5. 追加推奨事項

#### 新規ファイルの作成を推奨

**ファイル名**: `コンポーネント記述ルール_WEB検索_v2.txt`

最新のDify仕様に完全準拠した新しいルールファイルを作成し、段階的に移行することを推奨。

#### バージョン管理の導入

各コーディングルールファイルにバージョン番号と最終更新日を記載し、Difyのバージョンアップに合わせて定期的に更新する体制を構築。

## まとめ

現在のコーディングルールは、Difyの実際の動作環境と乖離しており、特にtoolノードの記述方法について大幅な見直しが必要。上記の改善を実施することで、ルールに従って作成したYMLファイルが正常に動作するようになる。