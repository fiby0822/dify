# Dify開発ルール改善案 - Google Sheets marketplace plugin使用許可について

## 1. 改善案の概要

Google Sheetsとの連携機能を実現するために、現在コーディングルールで禁止されているmarketplace pluginの使用について、以下の特定プラグインのみ許可する改善案を提案します。

### 許可対象プラグイン
- omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f

## 2. 改善が必要なルール

### 2.1 全体コーディングルール（/コーディングルール/全体コーディングルール/全体コーディングルール.md）

#### 現在のルール（セクション2.2）
```yaml
# 依存関係がない場合（必須）
dependencies: []

# 依存関係がある場合
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/openai:0.0.26@xxxxx
```

#### 改善案
セクション2.2の後に以下を追加：

```yaml
### 2.2.1 Google Sheets操作に関する特例

Google Sheets操作については、以下のmarketplace pluginの使用を許可します：

```yaml
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f
```

**重要な注意事項**：
- このプラグインのみが許可対象です
- 他のmarketplace pluginは引き続き使用禁止です
- 必ずprovider_type: builtinを使用してください（marketplaceは使用禁止）
```

### 2.2 コンポーネント記述ルール_GoogleShpredSheet操作.txt

#### 現在のルール
すでにomluc/google_sheetsの使用を前提としたルールが記載されているため、marketplace plugin使用許可の明記が必要。

#### 改善案
ファイルの冒頭に以下を追加：

```
■重要な許可事項
Google Sheets操作に限り、以下のmarketplace pluginの使用が許可されています：
- omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f

この許可は他のmarketplace pluginには適用されません。
```

## 3. 品質チェックリストへの追加項目

### 3.1 品質チェックリスト.md（セクション0.8）

#### 追加項目
```markdown
### 0.8 マーケットプレイスツールの依存関係確認

#### Google Sheets操作時の特別確認
- [ ] Google Sheets操作を使用する場合、許可されたプラグインのみを使用している
- [ ] 識別子が完全一致している：omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f
- [ ] provider_typeがbuiltinに設定されている（marketplaceは使用禁止）
- [ ] 他のmarketplace pluginを使用していない
```

### 3.2 品質チェックリスト.md（セクション4.13.1）

#### 追加確認項目
```markdown
##### Google Sheets marketplace plugin確認
- [ ] **dependenciesに許可されたGoogle Sheetsプラグインのみが定義されている**
- [ ] **識別子のハッシュ値まで完全一致している**
- [ ] **バージョン0.0.2を使用している（他のバージョンは未検証）**
```

## 4. クラッシュ事項チェックリストへの追加項目

### 4.1 クラッシュ事項チェックリスト.md（セクション0.8）

#### 改善案
現在のセクション0.8を以下のように更新：

```markdown
## 0.8 マーケットプレイスツールの依存関係未定義

### 症状
- ツール実行時に「Tool not found」エラー
- 「Unable to initialize tool」メッセージ
- Google Sheets操作時に「Invalid credentials」エラー

### 原因
- dependenciesセクションにマーケットプレイスツールの定義が欠落
- marketplace_plugin_unique_identifierの不一致
- provider_nameが正しく設定されていない

### Google Sheets固有の例
```yaml
# 間違った例：依存関係が未定義
app:
  name: "Google Sheets操作"
  # dependenciesが欠落

# 正しい例（許可されたプラグインのみ）：
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f
```

### チェック項目
- [ ] dependenciesセクションが存在する
- [ ] Google Sheetsツールを使用する場合、許可された識別子が完全一致で記載されている
- [ ] バージョン番号が0.0.2である（他のバージョンは未許可）
- [ ] ハッシュ値が完全一致している
```

## 5. その他の推奨事項

### 5.1 Google Sheets操作時の注意事項ドキュメント作成

以下の内容を含む専用ドキュメントの作成を推奨：

1. **許可されたプラグインの明確化**
   - 識別子の完全記載
   - 使用可能な機能の一覧
   - 制限事項

2. **実装例**
   - batch_get（データ取得）の完全例
   - batch_update（データ更新）の完全例
   - エラーハンドリングの例

3. **トラブルシューティング**
   - よくあるエラーと対処法
   - デバッグ方法
   - 問い合わせ先

### 5.2 バージョン管理方針

Google Sheetsプラグインのバージョンアップ時の方針：
1. 新バージョンは検証後に許可リストに追加
2. 旧バージョンは一定期間後に非推奨化
3. バージョン間の互換性情報を明記

## 6. 実装優先順位

1. **即時対応**（優先度：高）
   - 全体コーディングルールへの特例追加
   - 品質チェックリストへの項目追加
   - クラッシュ事項チェックリストの更新

2. **短期対応**（優先度：中）
   - Google Sheets操作専用ドキュメントの作成
   - 実装例の充実

3. **長期対応**（優先度：低）
   - バージョン管理プロセスの確立
   - 他のmarketplace pluginの評価と許可検討

## 7. リスク評価と対策

### 7.1 リスク
- 特定プラグインへの依存度上昇
- バージョン固定による将来的な機能制限
- 他のmarketplace plugin使用要望の増加

### 7.2 対策
- 定期的なプラグイン動作確認
- 代替手段の検討（カスタムツール開発等）
- 許可プラグインの段階的拡張プロセス確立

## 8. 結論

Google Sheets操作はビジネスアプリケーションにおいて重要な機能であり、marketplace pluginの限定的な使用許可は合理的な判断です。ただし、セキュリティと安定性を維持するため、許可対象を明確に限定し、適切な管理プロセスを確立することが重要です。

この改善案により、開発者はGoogle Sheets連携機能を安全に実装できるようになり、同時にシステム全体の品質も維持されます。