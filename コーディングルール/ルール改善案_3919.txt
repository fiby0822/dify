Difyコーディングルール改善案
作成日：2025年1月3日
ファイル番号：3919

===============================================
■ 改善が必要な項目一覧
===============================================

【1】provider_typeの有効値明確化（最優先）

現状の問題：
- provider_typeに'marketplace'を使用してエラー多発
- 有効な値のリストがルールに記載されていない

改善案：
「コンポーネント記述ルール_GoogleShpredSheet操作.txt」に以下を追加

```
■provider_typeの設定（重要）
Google Sheetsツールを使用する際のprovider_typeは以下のいずれかを使用：

【推奨】provider_type: builtin
- Difyに組み込まれているツールとして使用
- 安定性が高い

【非推奨】provider_type: marketplace
- エラーの原因となるため使用禁止

【有効な値一覧】
- builtin: 組み込みツール（推奨）
- plugin: プラグイン
- workflow: ワークフロー
- api: API
- app: アプリケーション
- dataset-retrieval: データセット検索

※'marketplace'は無効な値です。使用するとエラーになります。
```

【2】tool_configurationsフィールドの必須化

現状の問題：
- tool_configurationsが欠落してエラー発生
- 必須フィールドであることが明記されていない

改善案：
「コンポーネント記述ルール_GoogleShpredSheet操作.txt」に以下を追加

```
■tool_configurationsセクション（必須）

Google Sheetsツールノードには必ずtool_configurationsを設定してください：

```yaml
tool_configurations:
  SheetsScopes: 1  # 必須：読み書き権限（0/1形式）

# 追加で設定可能な項目
is_team_authorization: true  # チーム認証を使用
```

【重要】このセクションが欠落するとエラーになります。
```

【3】完全な実装例の更新

現状の問題：
- 実装例にtool_configurationsが含まれていない
- provider_typeが正しく設定されていない例がある

改善案：
既存の実装例を以下のように更新

```yaml
# データ読み取りノード（修正版）
- data:
    type: tool
    provider_id: omluc/google_sheets
    provider_name: Google Sheets
    provider_type: builtin  # marketplaceではなくbuiltin
    tool_label: Google Sheets
    tool_name: batch_get
    tool_configurations:  # 必須セクション
      SheetsScopes: 1
    is_team_authorization: true  # 推奨
    tool_parameters:
      ranges:
        type: mixed
        value: '["INPUT!A1:C10"]'
      spreadsheet_id:
        type: mixed
        value: "1dd5IPZBYY5ZtImb48SLnO8c9b4Z8w5YUr1gWF0STqSQ"
    selected: false
    title: Google Sheets読み取り
    desc: 入力データを取得
```

【4】rangesパラメータのJSON形式チェック強化

現状の問題：
- rangesの閉じ括弧忘れによるJSON形式エラー
- 引用符の付け忘れ

改善案：
「品質チェックリスト.md」のGoogle Sheets関連セクションに追加

```
#### rangesパラメータの形式確認（重要）
- [ ] JSON配列が正しく閉じられているか（[で始まり]で終わる）
- [ ] 配列全体が引用符で囲まれているか
- [ ] 各範囲指定が二重引用符で囲まれているか

正：value: '["INPUT!A1:C10"]'
誤：value: '["INPUT!A1:C10"'  # 閉じ括弧なし
誤：value: ["INPUT!A1:C10"]    # 外側の引用符なし
```

【5】依存関係の正しい記述方法明確化

現状の問題：
- 新旧形式の混在
- marketplace識別子の記述方法が不明確

改善案：
「全体コーディングルール.md」の依存関係セクションを更新

```yaml
# Google Sheets使用時の依存関係（新形式）
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f

# 注意：@langgenius/google-sheetsは旧形式のため使用禁止
```

【6】エラー防止チェックリストの拡充

改善案：
「クラッシュ事項チェックリスト.md」に以下を追加

```
## 13.9 provider_type関連のクラッシュ防止

### 症状
- "provider_type Input should be 'plugin', 'builtin'..."エラー
- ツールノードの初期化失敗

### 原因
- 無効なprovider_type値の使用（特に'marketplace'）
- tool_configurationsの欠落

### チェック項目
- [ ] **provider_typeが有効な値（builtin推奨）**
- [ ] **'marketplace'を使用していない**
- [ ] **tool_configurationsセクションが存在する**
- [ ] **SheetsScopes: 1が設定されている**

### 防止策
すべてのGoogle Sheetsツールノードで以下を確認：
1. provider_type: builtin
2. tool_configurationsセクションの存在
3. is_team_authorization: trueの設定
```

【7】トラブルシューティングセクションの追加

改善案：
「コンポーネント記述ルール_GoogleShpredSheet操作.txt」の末尾を拡充

```
### エラー：provider_type Input should be...
原因：provider_typeに無効な値を設定
対策：provider_type: builtinに変更

### エラー：tool_configurations Field required
原因：tool_configurationsセクションの欠落
対策：以下を追加
```yaml
tool_configurations:
  SheetsScopes: 1
```
```

【8】成功例の分析結果反映

検証YML_5931.yml（成功例）の特徴：
- 依存関係なしでも正常動作
- 基本ノードタイプのみ使用
- 明確な構造とエラーハンドリング

改善案：
「全体コーディングルール.md」に追加

```
### 推奨アーキテクチャパターン
1. 基本ノードタイプ（start、llm、if-else、answer）を優先使用
2. 外部ツール使用時は必ずエラーハンドリングを実装
3. 複雑な処理は複数のシンプルなノードに分割
```

===============================================
■ 実施優先順位
===============================================

1. provider_typeとtool_configurationsの明確化（最優先）
2. 実装例の全面更新
3. エラー防止チェックリストの拡充
4. トラブルシューティングセクションの追加
5. その他の改善項目

これらの改善により、同様のエラーの再発を防止できます。