# Dify開発用 品質チェックリスト

## 概要
本チェックリストは、Difyワークフローの開発後に実施する品質確認項目をまとめたものです。
各項目を順番に確認し、すべてにチェックが付くことを確認してください。

---

## 0. 致命的エラーチェック（最優先）

これらの項目が一つでも欠けるとアプリケーションがクラッシュします：

### 0.1 必須セクションの存在確認
- [ ] 最上位に`app`セクションが存在する
- [ ] 最上位に`dependencies: []`が存在する（空配列でも必須）
- [ ] 最上位に`kind: app`が存在する
- [ ] 最上位に`version: 0.3.0`が存在する
- [ ] 最上位に`workflow`セクションが存在する

### 0.2 必須フィールドの存在確認
- [ ] `app.use_icon_as_answer_icon`が設定されている
- [ ] `workflow.conversation_variables: []`が存在する
- [ ] `workflow.environment_variables: []`が存在する
- [ ] `workflow.features`セクションが存在する（最上位ではなくworkflow内）
- [ ] `workflow.graph.edges`が存在する
- [ ] `workflow.graph.nodes`が存在する

### 0.3 構造エラーの確認
- [ ] `features`セクションが最上位に配置されていない（workflow内に配置）
- [ ] YAMLファイル内にコメント（#で始まる行）が含まれていない

---

## 1. 基本構造チェック

### 1.1 YAMLファイル構造
- [ ] YAMLファイルが正しい構文で記述されている
- [ ] インデントが一貫している（スペース2個）
- [ ] 文字コードがUTF-8である
- [ ] 日本語文字が正しくエンコードされている
- [ ] YAMLファイル内にコメントが含まれていないか確認
- [ ] もしコメントがある場合、nodes/edges配列の要素内にないか確認
- [ ] コメントの代わりにdescフィールドが適切に使用されているか確認

### 1.2 必須セクション（クリティカル）
- [ ] `app`セクションが存在する
- [ ] `app.use_icon_as_answer_icon`が明示的に設定されている（省略厳禁）
- [ ] `dependencies`セクションが存在する（空配列でも必須）
- [ ] `kind: app`が設定されている（省略するとクラッシュ）
- [ ] `version: 0.3.0`が設定されている（省略するとクラッシュ）
- [ ] `workflow`セクションが存在する
- [ ] `workflow.conversation_variables`が存在する（空配列でも必須）
- [ ] `workflow.environment_variables`が存在する（空配列でも必須）
- [ ] `workflow.features`セクションが存在する（modeに関わらず必須）
- [ ] `workflow.graph`セクションが存在する
- [ ] `workflow.graph.nodes`と`workflow.graph.edges`が存在する

### 1.2.2 クラッシュ防止のための必須チェック
- [ ] `dependencies: []`が最上位に存在する（空配列でも必須）
- [ ] `kind: app`が最上位に存在する
- [ ] `version: 0.3.0`が最上位に存在する
- [ ] `workflow.conversation_variables: []`が存在する（空配列でも必須）
- [ ] `workflow.environment_variables: []`が存在する（空配列でも必須）
- [ ] `app.use_icon_as_answer_icon`が設定されている
- [ ] すべてのエッジに`selected: false`が設定されている
- [ ] すべてのエッジに`zIndex: 0`が設定されている
- [ ] すべてのエッジのdataに`isInLoop: false`が設定されている

### 1.2.1 セクション配置チェック
- [ ] `opening_statement`が`workflow.features`内に配置されている（appセクション直下ではない）
- [ ] 各セクションが正しい階層に配置されている

### 1.3 アプリケーションモード
- [ ] `app.mode`が"advanced-chat"である（推奨）
- [ ] workflowモードの場合、featuresセクションが存在しないことを確認
- [ ] workflowモードの場合、edgesとnodesがworkflow直下にあることを確認
- [ ] workflowモードを使用する場合、その理由が明確である
- [ ] workflowモードの場合、追加の制約事項を理解している

### 1.4 依存関係
- [ ] `dependencies`セクションが存在する（必須）
- [ ] 依存関係がない場合は`dependencies: []`と記載されている
- [ ] 必要なプラグインが正しく指定されている

---

## 2. アプリケーション設定チェック

### 2.1 基本情報
- [ ] アプリ名（`app.name`）が分かりやすい日本語で記述されている
- [ ] 説明文（`app.description`）が具体的で明確である
- [ ] アイコン（`app.icon`）が1文字の絵文字である
- [ ] アイコン背景色（`app.icon_background`）が#XXXXXXの形式である
- [ ] `app.mode`が適切に設定されている（advanced-chat推奨）
- [ ] `app.use_icon_as_answer_icon: false`が設定されている

### 2.2 機能設定（features）
- [ ] `opening_statement`で使い方が明確に説明されている
- [ ] `opening_statement`がstring型であることを確認（boolean不可）
- [ ] `opening_statement`を省略する場合は、フィールド自体を削除
- [ ] `suggested_questions`に3-4個の実用的な例が含まれている
- [ ] ファイルアップロードが必要な場合、`file_upload`が適切に設定されている
- [ ] 許可するファイル拡張子が大文字で記述されている（例: .PDF）
- [ ] `text_to_speech`がenabledがfalseでも、languageとvoiceフィールドを空文字列で定義

---

## 3. ワークフローチェック

### 3.1 ノード構成
- [ ] `start_node`が存在する
- [ ] 終了ノード（`answer`または`end`）が存在する
- [ ] すべてのノードにユニークなIDが設定されている
- [ ] ノードIDがsnake_case形式である（数値のみのIDを使用していない）
- [ ] 各ノードの`type`が正しい値である

### 3.1.1 ノードtype属性チェック
- [ ] すべてのノードの外側type属性が`custom`に設定されている
- [ ] startノードはdata.typeが`start`
- [ ] llmノードはdata.typeが`llm`
- [ ] answerノードはdata.typeが`answer`
- [ ] 外側のtype属性は全て"custom"で統一されている

### 3.2 ノード配置
- [ ] ノードの`position`が適切に設定されている
- [ ] ノードの`positionAbsolute`が`position`と同じ値に設定されている
- [ ] ノードに`height`と`width`が設定されている
- [ ] ノードが重ならないように配置されている
- [ ] x座標が50単位で整列されている（50, 350, 650...）
- [ ] フローが左から右へ流れるように配置されている

### 3.3 エッジ（接続）
- [ ] すべてのノードが適切に接続されている
- [ ] `start_node`からすべてのノードに到達可能である
- [ ] 無限ループが存在しない
- [ ] エッジのIDがユニークである
- [ ] `source`と`target`が正しく設定されている
- [ ] `sourceHandle`と`targetHandle`が適切に設定されている
- [ ] 各エッジに`selected: false`と`zIndex: 0`が設定されている
- [ ] 各エッジの`data`に`sourceType`と`targetType`が設定されている

---

## 4. コンポーネント別チェック

### 4.1 startノード
- [ ] **advanced-chatモードの場合、variablesが空配列[]である**（重要）
- [ ] workflowモードの場合のみ、必要な入力変数が定義されている
- [ ] 変数名がsnake_caseである（workflowモードの場合）
- [ ] 変数のラベルが日本語で分かりやすい（workflowモードの場合）
- [ ] `required`フラグが適切に設定されている（workflowモードの場合）
- [ ] ファイル入力の場合、適切な制限が設定されている（workflowモードの場合）

### 4.1.1 変数定義の形式
- [ ] typeフィールドが有効な値である
  - 有効: "text-input", "paragraph", "select", "number", "file", "file-list", "external_data_tool"
  - 無効: "text"（よくある間違い）
- [ ] type: "text"を使用していない（エラーの原因）
- [ ] advanced-chatモードでvariablesに要素を追加していない

### 4.1.2 変数定義のエラーチェック
- [ ] type: "text"を使用していない（エラーになる）
- [ ] typeフィールドに有効な値を使用している
- [ ] 変数定義のフィールド順序が正しい（variable → type → label → その他）
- [ ] advanced-chatモードで適切な入力方法を選択している

### 4.2 llmノード
- [ ] モデル設定（provider, name, mode）が正しい
- [ ] システムプロンプトで役割が明確に定義されている
- [ ] ユーザープロンプトで変数が適切に参照されている
- [ ] 出力形式が明確に指定されている
- [ ] `completion_params`が適切に設定されている
- [ ] `structured_output_enabled`が設定されている
- [ ] `vision.enabled`が設定されている
- [ ] prompt_templateの各要素に`id`属性が設定されている
- [ ] prompt_templateのidがユニークである
- [ ] `variables`フィールドが設定されているか、または省略されている（オプション）
- [ ] `context`フィールドが設定されている（enabled: false, variable_selector: []）
- [ ] プロバイダー名がシンプルな形式である（例：`openai`、`langgenius/openai/openai`ではない）
- [ ] memory設定が正しい形式で記述されている（使用する場合）
  - [ ] windowフィールドが含まれている（enabled, size）
  - [ ] role_prefixが含まれている（推奨）
  - [ ] または、memoryフィールドが完全に省略されている（推奨）

### 4.3 codeノード
- [ ] `code_language`が`python3`である
- [ ] `main`関数が定義されている
- [ ] 入力変数が正しくマッピングされている
- [ ] 出力変数の型が正しく定義されている
- [ ] エラーハンドリングが実装されている

### 4.4 if-elseノード
- [ ] 条件が明確で理解しやすい
- [ ] 比較演算子が適切である
- [ ] 論理演算子（and/or）が正しく使用されている
- [ ] すべての分岐が適切に処理されている

### 4.5 その他のノード
- [ ] document-extractorの入力ファイルが正しく指定されている
- [ ] parameter-extractorの抽出項目が明確に定義されている（注：使用は要検討）
- [ ] knowledge-retrievalの検索設定が適切である
- [ ] answerノードで適切な出力が生成されている

---

## 5. 変数と参照チェック

### 5.1 変数参照
- [ ] 変数参照の形式が正しい（`{{#node_id.variable#}}`）
- [ ] 参照先の変数が実際に存在する
- [ ] `value_selector`の配列形式が正しい
- [ ] 未定義変数への参照がない

### 5.2 データフロー
- [ ] データの流れが論理的である
- [ ] 必要なデータがすべて後続ノードに渡されている
- [ ] 不要なデータ転送がない

---

## 6. エラーハンドリングチェック

### 6.1 入力検証
- [ ] ファイル入力の存在チェックが実装されている
- [ ] 必須入力項目の検証が行われている
- [ ] 入力値の妥当性チェックが実装されている

### 6.2 エラー処理
- [ ] 各ノードでエラー時の処理が考慮されている
- [ ] エラーメッセージが日本語で分かりやすい
- [ ] エラー時の代替フローが用意されている

---

## 7. ユーザビリティチェック

### 7.1 使いやすさ
- [ ] 初回利用者でも使い方が理解できる
- [ ] 入力項目が多すぎない
- [ ] 処理の進行状況が分かる

### 7.2 出力品質
- [ ] 出力が明確で理解しやすい
- [ ] 必要な情報がすべて含まれている
- [ ] フォーマットが一貫している

---

## 8. パフォーマンスチェック

### 8.1 処理効率
- [ ] 不要な処理が含まれていない
- [ ] 並列処理可能な部分が最適化されている
- [ ] 大量データ処理時の考慮がされている

### 8.2 リソース使用
- [ ] メモリ使用量が適切である
- [ ] ファイルサイズの制限が適切である
- [ ] タイムアウト設定が考慮されている

---

## 9. セキュリティチェック

### 9.1 入力検証
- [ ] 悪意のある入力に対する防御がある
- [ ] ファイルタイプの制限が適切である
- [ ] SQLインジェクション等の脆弱性がない

### 9.2 データ保護
- [ ] 機密情報が適切に扱われている
- [ ] ログ出力に機密情報が含まれていない
- [ ] 必要に応じてデータがマスキングされている

---

## 10. 最終確認

### 10.1 インポートテスト
- [ ] YAMLファイルがDifyに正常にインポートできる
- [ ] インポート時にエラーが発生しない
- [ ] UIで正しく表示される

### 10.2 動作確認
- [ ] 基本的な使用ケースで正常に動作する
- [ ] エッジケースで適切に処理される
- [ ] エラー時に適切なメッセージが表示される

### 10.3 ドキュメント
- [ ] 使用方法が明確に記載されている
- [ ] 制限事項が明記されている
- [ ] 更新履歴が記録されている

### 10.3.1 インポートエラー診断
インポートが失敗した場合、以下を確認：
- [ ] opening_statementの配置位置（app vs workflow.features）
- [ ] opening_statementにユーザープロンプトで変数が適切に参照されている
- [ ] 必須フィールドの欠落
- [ ] YAMLの構文エラー
- [ ] LLMノードのvariablesフィールドの欠落

### 10.3.2 表示エラー診断（インポート成功but表示失敗）
表示が失敗した場合、以下を確認：
- [ ] ノードのtype属性が"custom"になっているか（data.typeと異なる値）
- [ ] LLMノードにcontext/memoryフィールドを追加してみる
- [ ] variables配列を省略または追加してみる
- [ ] providerの表記をシンプルな形式に変更（例：openai）

### 10.3.3 クラッシュ診断（インポート成功butアプリクラッシュ）
アプリケーションがクラッシュした場合、以下を確認：
- [ ] YAMLファイル内のコメント（#で始まる行）を全て削除
- [ ] nodes/edges配列要素内にコメントが含まれていないか確認
- [ ] data構造内にコメントが含まれていないか確認
- [ ] provider名がシンプルな形式になっているか確認
- [ ] 不要な改行や空白が構造を破壊していないか確認
- [ ] app.use_icon_as_answer_iconが設定されているか
- [ ] dependencies、kind、versionの3点セットが揃っているか
- [ ] app.modeがworkflowになっていないか（advanced-chatへの変更を検討）
- [ ] workflow.featuresセクションが存在するか
- [ ] エッジ定義にselected、zIndexが含まれているか

### 10.3.4 動作エラー診断（実行時エラー）
実行時にエラーが発生した場合、以下を確認：

#### "xxx is required in input form"エラー
- [ ] advanced-chatモードでstartノードに変数を定義していないか
- [ ] startノードのvariablesが空配列[]になっているか
- [ ] LLMノードでの変数参照が正しいか

#### "Input should be 'text-input'..."エラー
- [ ] 変数のtype定義が有効な値になっているか
- [ ] type: "text"を使用していないか（text-inputが正しい）
- [ ] その他の無効な型を使用していないか

#### "memory.window Field required"エラー
- [ ] LLMノードのmemory設定にwindowフィールドが含まれているか
- [ ] windowフィールドにenabledとsizeプロパティが設定されているか
- [ ] または、memory設定自体を削除しているか（推奨）

対処法：
1. memory設定を削除する（最も簡単）
2. memory設定を残す場合は、以下の構造にする：
   ```yaml
   memory:
     enabled: false
     window:
       enabled: false
       size: 10
   ```

#### 一般的な対処法
1. advanced-chatモードの場合：
   - startノードのvariablesを空配列にする
   - ユーザー入力はシステム変数で参照
   
2. workflowモードの場合：
   - 変数定義の型が正しいか確認
   - 必須フィールドがすべて設定されているか確認

---

## 11. 型の整合性チェック

### 型の一致確認
- [ ] `opening_statement`が文字列型である（boolean不可）
- [ ] `suggested_questions`が文字列の配列である
- [ ] enabled系プロパティがboolean型である
- [ ] 数値型フィールド（height, width, max_tokens等）が数値である
- [ ] 文字列型フィールドが適切に引用符で囲まれている

---

## 12. モード別ベストプラクティスガイド

### 12.1 advanced-chatモード（推奨）
**用途**: チャット形式の対話型アプリケーション

#### 必須ルール
1. startノードのvariablesは必ず空配列`[]`
2. ユーザー入力はシステムが自動管理
3. featuresセクションでUI設定を行う

#### 正しい構造例
```yaml
nodes:
  - data:
      desc: ''
      selected: false
      title: 開始
      type: start
      variables: []  # 必須：空配列
    # ... その他の設定
```

### 12.2 workflowモード（上級者向け）
**用途**: カスタム入力が必要な複雑なワークフロー

#### 特徴
1. startノードで変数定義可能
2. featuresセクションが不要
3. より柔軟だが、エラーが発生しやすい

#### 使用する場合の注意
- 本当に必要か再検討する
- 可能ならadvanced-chatモードを使用
- 変数の型定義を正確に行う

---

## チェックリスト使用方法

1. **開発完了後**：すべての項目を上から順番にチェック
2. **問題発見時**：該当箇所を修正し、再度チェック
3. **リリース前**：すべての項目にチェックが付いていることを確認
4. **定期レビュー**：既存アプリケーションの品質維持のため定期的に実施

## 判定基準

- **合格（A）**：すべての項目にチェックが付いている
- **要改善（B）**：90%以上の項目にチェックが付いている
- **要修正（C）**：80%以上の項目にチェックが付いている
- **不合格（D）**：80%未満の項目しかチェックが付いていない

品質基準を満たさない場合は、チェックが付いていない項目を優先的に改善してください。