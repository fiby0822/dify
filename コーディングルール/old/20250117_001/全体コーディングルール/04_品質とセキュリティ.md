# Dify開発用 全体コーディングルール - 品質とセキュリティ

関連ファイル:
- [インデックス](./00_index.md)
- [基本構造とエラー防止](./01_基本構造とエラー防止.md)
- [トラブルシューティング](./05_トラブルシューティング.md)
- [ドキュメントと設定](./07_ドキュメントと設定.md)

## 7. 品質管理

### 7.1 バージョン管理
**重要**: Dify YMLファイルは必ず`version: 0.3.0`を使用してください。

- **必須バージョン**: `version: 0.3.0`（これ以外は使用禁止）
- **禁止バージョン**: 
  - `version: 0.1.x`（古いバージョン、動作保証外）
  - `version: 0.2.x`（古いバージョン、動作保証外）
  - その他のバージョン（サポート外）
- **記載位置**: 最上位レベル（dependencies、kind、versionの順序を推奨）
- **注意事項**: 
  - `fiby_version`は廃止されたフィールドです。使用しないでください
  - バージョンが異なると比較演算子の挙動やフィールド要件が変わる可能性があります
  - 必ずversion: 0.3.0を固定で使用してください

### 7.2 テスト方針
- 単体テスト: 各ノードの動作確認
- 結合テスト: ワークフロー全体の動作確認
- エッジケーステスト: 異常系の動作確認

## 8. セキュリティ考慮事項

### 8.1 入力検証
- ユーザー入力の適切な検証
- ファイルタイプの制限
- サイズ制限の実装

### 8.2 データ保護
- 機密情報の適切な処理
- ログ出力時の情報マスキング

### 8.3 Google Sheets操作関連

#### 8.3.1 データ形式の確認
- [ ] batch_updateのdataパラメータがJSON配列形式になっているか
- [ ] 各要素が{"range": "A1:B2", "values": [[...]]}形式か
- [ ] valuesが2次元配列形式になっているか
- [ ] JSONパラメータにエスケープが必要な文字が含まれていないか
- [ ] template-transformノードでtojsonフィルタを使用する場合の注意事項を理解しているか

#### 8.3.2 toolノードのパラメータ形式

**tool_parameters（実行時パラメータ）**
- 用途：ツール実行時に渡される実際のパラメータ
- 形式：type/value形式で記述が必須
- 例：
  ```yaml
  tool_parameters:
    ranges:
      type: mixed
      value: '["INPUT!A1:C10"]'
    spreadsheet_id:
      type: mixed
      value: "1dd5IPZBYY5ZtImb48SLnO8c9b4Z8w5YUr1gWF0STqSQ"
  ```

#### 8.3.3 よくあるエラーと対策
- rangesパラメータの引用符不足（全体を引用符で囲む）
- LLM出力を直接batch_updateのdataに使用（template-transformで整形が必要）
- JSON配列の形式不正（閉じ括弧の欠落等）

## 9. パフォーマンス最適化

### 9.1 処理効率
- 不要な処理の削減
- 並列処理可能な部分の最適化

### 9.2 リソース管理
- メモリ使用量の考慮
- ファイルサイズの制限

### 9.3 ファイルサイズとパフォーマンス

#### 推奨サイズ
- **推奨行数**: 500行以内（最速パフォーマンス）
- **最大行数**: 800行（これを超えると処理が重くなる）
- **ファイルサイズ**: 100KB以内を推奨

#### サイズ削減のテクニック
1. **不要な空白行の削除**
2. **コメントの完全削除**（本番環境）
3. **重複するコードの共通化**
4. **大規模ワークフローの分割**
   - 機能単位でファイルを分ける
   - 共通部分をテンプレート化

#### パフォーマンスへの影響
```
ファイルサイズ別の処理時間目安：
- 〜50KB: 瞬時（<1秒）
- 50-100KB: 高速（1-2秒）
- 100-200KB: 標準（2-5秒）
- 200KB〜: 遅延（5秒以上）
```

### 9.4 トークン数管理の基本
- LLMノードのトークン数制限を考慮した設計
- 大量データ処理時の分割処理
- 詳細は[外部連携とツール](./06_外部連携とツール.md)を参照

## 11. 互換性とアップデート

### 11.1 後方互換性
- 既存機能の変更時は互換性を考慮
- 破壊的変更は避ける

### 11.2 アップデート方針
- 段階的な機能追加
- 十分なテスト後のリリース