# Dify YMLクラッシュ事項チェックリスト

## 概要
このチェックリストは、インポート成功後にアプリケーションがクラッシュする原因となる項目をまとめたものです。
品質チェックリストとは別に、クラッシュ防止に特化したチェックリストとして使用してください。

## 1. 最優先チェック項目

### 1.1 YAMLコメント
- [ ] YAMLファイル内に#で始まるコメントが一切ない
- [ ] nodes配列の要素内にコメントが含まれていない
- [ ] edges配列の要素内にコメントが含まれていない
- [ ] data構造内にコメントが含まれていない
- [ ] 配列要素の間にコメントが含まれていない
- [ ] codeノード内のPythonコードにもコメントがない

### 1.2 必須フィールド
- [ ] app.use_icon_as_answer_icon が設定されている（boolean型）
- [ ] エッジのdata.isInLoop が false（isInIterationではない）
- [ ] エッジのselected: false
- [ ] エッジのzIndex: 0
- [ ] dependencies: []（空でも必須）
- [ ] kind: app（固定値）
- [ ] version: 0.3.0（固定値）

## 2. codeノード関連

### 2.1 システム変数参照
- [ ] Pythonコード内で`sys.query`を直接参照していない
- [ ] Pythonコード内で`{{#node.variable#}}`形式を使用していない
- [ ] システム変数はvariablesセクションで宣言されている
- [ ] ローカル変数名を使用している

### 2.2 変数宣言の形式
- [ ] variables配列が正しく定義されている
- [ ] value_selectorが配列形式になっている（文字列ではない）
- [ ] variableフィールドでローカル変数名が定義されている

### 2.3 Pythonコード
- [ ] コメントが含まれていない（#で始まる行）
- [ ] インラインコメントも含まれていない
- [ ] インデントが正しい
- [ ] return文が存在する
- [ ] 存在しない可能性がある変数は'in locals()'でチェック

## 3. ノード構成関連

### 3.1 answerノード
- [ ] answerノードが5個以下
- [ ] 6個以上の場合、集約型への変更を検討している
- [ ] 過度な独立answer型の使用を避けている

### 3.2 IF_ELSEノード
- [ ] 連続接続を避けている（IF_ELSE → false → IF_ELSE の連鎖）
- [ ] case_idが全てのケースに設定されている
- [ ] Unicode演算子を正しく使用している（≥、≤、≠）
- [ ] sourceHandleがcase_idと一致している
- [ ] デフォルト分岐のsourceHandleが"false"（文字列）

### 3.3 全体構成
- [ ] 総ノード数が20個以下（推奨）
- [ ] 総ノード数が50個以下（最大）
- [ ] 複雑な分岐構造を避けている
- [ ] graphセクション内にnodes/edgesが配置されている

## 4. 変数参照関連

### 4.1 実行パスの保証
- [ ] 実行されない可能性があるノードの変数を参照していない
- [ ] 条件分岐の各パスで独立して処理が完結している
- [ ] 複数分岐の結果を一つのノードで統合していない

### 4.2 変数の型と設定
- [ ] advanced-chatモードでstartノードのvariablesが空配列[]
- [ ] ユーザー入力を{{#sys.query#}}で参照している
- [ ] 変数の型定義が正確

## 5. LLMノード関連

### 5.1 memory設定
- [ ] memoryフィールドを使用する場合、windowフィールドが含まれている
- [ ] または、memoryフィールド自体を省略している
- [ ] 不完全なmemory構造を記述していない

### 5.2 context設定
- [ ] 必要な設定が完全に記述されている
- [ ] 部分的な設定で終わっていない

## 6. 構造とバージョン

### 6.1 YAMLファイル基本構造
- [ ] appセクションが最上位に存在
- [ ] workflowセクションが正しい位置に存在
- [ ] featuresがworkflow内に配置されている（最上位ではない）
- [ ] conversation_variables: []が存在（空でも必須）
- [ ] environment_variables: []が存在（空でも必須）

### 6.2 モードとバージョン
- [ ] version: 0.3.0を使用
- [ ] advanced-chatモードを使用（推奨）
- [ ] workflowモードの場合、制約を理解している

## 7. file_upload設定

### 7.1 基本設定
- [ ] enabledがfalseの場合、余分なフィールドを含めていない
- [ ] enabledがtrueの場合、file_size_limitが設定されている
- [ ] enabledがtrueの場合、allowed_extensionsが配列で設定されている
- [ ] allowed_extensionsの拡張子が大文字で記載されている（.PDF等）

## 判定基準
- **全項目にチェック** → クラッシュリスク低
- **1項目でも未チェック** → クラッシュリスク高

## 使用方法
1. YMLファイル作成後、このチェックリストの全項目を確認
2. 品質チェックリストと併用して使用
3. 特に赤字や太字の項目は重点的に確認
4. チェックが入らない項目は修正してから再度確認

## 注意事項
- このチェックリストは品質チェックリストとは異なり、クラッシュ防止に特化
- 両方のチェックリストを必ず実施すること
- 新たなクラッシュ原因が判明した場合は、このリストに追加すること