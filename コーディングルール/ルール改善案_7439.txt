# Difyコーディングルール改善案（Google Sheets操作関連）

## 改善対象
①全体コーディングルール
②GoogleShpredSheet操作のコンポーネント記述ルール
③品質チェックリスト
④クラッシュ事項チェックリスト

## 改善案の概要
Google Sheets操作において、特定のmarketplaceプラグイン（omluc/google_sheets:0.0.2）の使用を許可し、それに伴う各種ルールの更新を行う。

---

## ①全体コーディングルール の改善案

### 改善箇所：「0.3 JSON形式の記述エラー」セクション

#### 現状の問題
- 現在のルールではmarketplaceの使用が一律禁止されているが、特定のmarketplaceツールの使用を許可する必要がある

#### 追加内容
```yaml
### 0.3.1 許可されたmarketplaceツール
以下のmarketplaceツールについては使用を許可する：

#### Google Sheets操作
- omluc/google_sheets:0.0.2
  ```yaml
  dependencies:
  - current_identifier: null
    type: marketplace
    value:
      marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f
  ```

【注意】上記以外のmarketplaceツールの使用は引き続き禁止とする。
```

---

## ②コンポーネント記述ルール_GoogleShpredSheet操作.txt の改善案

### 改善箇所1：「■依存関係（必須）」セクション

#### 現在の記述
```
■依存関係（必須）
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f
```

#### 改善後の記述
```
■依存関係（必須）
Google Sheets操作では、以下の2つの方法が利用可能：

### 方法1：マーケットプレイスプラグイン（omluc/google_sheets:0.0.2）
```yaml
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f
```

### 方法2：組み込みツール（従来方式）
```yaml
dependencies: []  # 空配列でOK（組み込みツールのため）
```

【重要】使用する方法によってprovider_typeの設定が異なるため注意。
```

### 改善箇所2：「■provider_typeの設定（重要）」セクション

#### 現在の記述
```
【推奨】provider_type: builtin
- Difyに組み込まれているツールとして使用
- 安定性が高い

【非推奨】provider_type: marketplace
- エラーの原因となるため使用禁止
```

#### 改善後の記述
```
【状況別推奨設定】

1. omluc/google_sheets:0.0.2 を使用する場合
   - provider_type: builtinを使用（marketplaceではない）
   - 理由：このプラグインは特殊な処理により、builtinとして扱われる

2. その他のGoogle Sheetsツールを使用する場合
   - provider_type: builtinを使用
   - 通常の組み込みツールとして処理

【重要】どちらの場合も provider_type: marketplace は使用禁止。
```

### 改善箇所3：「■完全な実装例」セクション

#### 追加する実装例
```yaml
# omluc/google_sheets:0.0.2 を使用した実装例
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f

# データ読み取りノード（omluc版）
- data:
    type: tool
    provider_id: omluc/google_sheets/google_sheets
    provider_name: omluc/google_sheets/google_sheets
    provider_type: builtin  # marketplaceではなくbuiltin
    tool_label: Batch Get
    tool_name: batch_get
    tool_configurations:
      date_time_render_option: FORMATTED_STRING
      major_dimension: null
      value_render_option: null
    tool_parameters:
      ranges:
        type: mixed
        value: '["INPUT!A1:C10"]'
      spreadsheet_id:
        type: mixed
        value: "1dd5IPZBYY5ZtImb48SLnO8c9b4Z8w5YUr1gWF0STqSQ"
    is_team_authorization: true
    selected: false
    title: データ取得（omluc版）
    desc: ''
```

---

## ③品質チェックリスト.md の改善案

### 改善箇所1：「4.8 toolノード（外部ツール）」セクション

#### 追加チェック項目
```markdown
#### 4.8.1 Google Sheets (omluc/google_sheets:0.0.2) 固有の確認
- [ ] dependenciesに omluc/google_sheets:0.0.2 の定義がある場合：
  - [ ] marketplace_plugin_unique_identifierが完全一致している
  - [ ] provider_typeは builtin を使用している（marketplaceではない）
  - [ ] provider_idが omluc/google_sheets/google_sheets になっている
  - [ ] paramSchemasセクションが存在する場合、適切に設定されている
```

### 改善箇所2：「4.13.1 Google Sheets設定の完全性確認」セクション

#### 追加内容
```markdown
##### omluc/google_sheets:0.0.2 使用時の特別な注意事項
- [ ] **dependenciesでmarketplace typeを使用しているが、provider_typeはbuiltinになっているか**
- [ ] **paramSchemasが定義されている場合、tool_parametersと整合性があるか**
- [ ] **output_schemaフィールドがnullに設定されているか**
- [ ] **tool_descriptionsとtool_labelが正しく設定されているか**
```

---

## ④クラッシュ事項チェックリスト.md の改善案

### 改善箇所1：「13.9 provider_type設定エラー」セクション

#### 修正内容
現在の記述：
```
- [ ] **'marketplace'を使用していない**
```

改善後の記述：
```
- [ ] **'marketplace'を使用していない（例外：omluc/google_sheets:0.0.2の依存関係定義時のみ許可）**
```

### 改善箇所2：新規セクション追加

#### 追加セクション
```markdown
## 16.4 omluc/google_sheets:0.0.2 固有のクラッシュ防止

### 症状
- provider_type設定エラー
- パラメータスキーマの不一致
- 依存関係の定義エラー

### 原因
- dependenciesとprovider_typeの組み合わせミス
- paramSchemasとtool_parametersの不整合

### チェック項目
- [ ] **dependenciesではtype: marketplaceを使用**
- [ ] **toolノードではprovider_type: builtinを使用**
- [ ] **この組み合わせを逆にしていない**
- [ ] **paramSchemasが存在する場合、全パラメータが定義されている**

### 正しい設定例
```yaml
# 依存関係（marketplace type）
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f

# ツールノード（builtin type）
- data:
    type: tool
    provider_type: builtin  # ここはmarketplaceではない
    provider_id: omluc/google_sheets/google_sheets
```
```

---

## 実装上の注意事項

1. **互換性の維持**
   - 既存のGoogle Sheets実装（組み込みツール版）も引き続きサポート
   - 新旧両方の実装方法を明確に文書化

2. **エラーメッセージの改善**
   - omluc/google_sheets:0.0.2使用時の特有のエラーパターンを文書化
   - トラブルシューティングガイドの充実

3. **テストケースの追加**
   - omluc版と組み込み版の両方のテストケースを用意
   - 移行ガイドの作成

4. **段階的移行**
   - 既存の実装を急に変更せず、段階的に移行できるようにする
   - 両方の実装方法のメリット・デメリットを明確化

## まとめ
この改善により、Google Sheets操作において柔軟性が向上し、特定のmarketplaceツール（omluc/google_sheets:0.0.2）を安全に使用できるようになります。同時に、既存の実装との互換性も維持されます。