# Dify YAML検証ツール仕様

## 概要
本ドキュメントは、Dify YAMLファイルの自動検証ツールの仕様を定義します。
インポート前にYAMLファイルの構造と内容を検証し、エラーやクラッシュの原因となる問題を事前に検出することを目的とします。

## 必須チェック項目

### 1. YAMLシンタックス検証
- YAMLとして正しい構文であること
- インデントが一貫していること（スペース2個）
- 文字エンコーディングがUTF-8であること

### 2. 必須フィールド存在確認
以下のフィールドが存在することを確認：
- `app`セクション
  - `app.use_icon_as_answer_icon`
  - `app.name`
  - `app.description`
  - `app.icon`
  - `app.icon_background`
  - `app.mode`
- `dependencies`（空配列でも必須）
- `kind: app`
- `version: 0.3.0`
- `workflow`セクション
  - `workflow.conversation_variables`（空配列でも必須）
  - `workflow.environment_variables`（空配列でも必須）
  - `workflow.features`（advanced-chatモードの場合）
  - `workflow.graph`
    - `workflow.graph.nodes`
    - `workflow.graph.edges`

### 3. 禁止フィールド不在確認
以下のフィールドが存在しないことを確認：
- `fiby_version`
- `main`（トップレベル）
- `metadata`（トップレベル）
- `description`（トップレベル）
- `hash`（手動追加の場合）
- `mode`（トップレベル）
- `system_prompt`（トップレベル）
- `graph`（トップレベル）
- `variables`（トップレベル）

### 4. ノードID重複チェック
- すべてのノードIDがユニークであること
- IDがsnake_case形式であること（推奨）

### 5. エッジ整合性チェック
- すべてのエッジのsource/targetが実在するノードIDであること
- エッジに必須フィールドが含まれていること
  - `data.isInLoop`（isInIterationではない）
  - `selected`
  - `zIndex`
- sourceHandleがcase_idまたは"false"であること（IF-ELSEノードの場合）

### 6. if-else条件ID確認
- すべてのif-elseノードで、各条件に一意のIDが設定されていること
- case_idがidと一致していること

### 7. 変数参照パス検証
- プロンプト内の変数参照（{{#node_id.variable#}}）が実在するノードを指していること
- 参照先ノードが参照元より前に実行される位置にあること

### 8. YAMLコメントチェック
- YAMLファイル内に#で始まるコメントが含まれていないこと
- 特にnodes/edges配列内にコメントがないこと

### 9. 比較演算子チェック
- Unicode文字（≥、≤、≠）の使用を検出し、警告を出すこと
- ASCII文字（>=、<=、!=）への変換を提案すること

### 10. CODEノードoutputsチェック
- outputsにdescriptionフィールドが含まれていないこと
- 正しい形式（value_selectorとvariableの配列）であること

## 警告レベルチェック

以下の項目は警告として報告（エラーではない）：

### 1. ノード数上限
- 総ノード数が30個を超える場合
- Answerノードが5個を超える場合

### 2. IF-ELSE深さ
- 条件分岐の深さが3階層を超える場合

### 3. パフォーマンス
- YAMLファイルが800行を超える場合
- 単一のcodeノードが100行を超える場合

### 4. 変数型の確認
- startノードで`type: "text"`を使用している場合（`text-input`が正しい）

### 5. boolean値の型確認
- "true"/"false"（文字列）とtrue/false（boolean）の混在

## 実装例（シェルスクリプト）

```bash
#!/bin/bash
# Dify YAML検証スクリプト

FILE=$1

echo "=== Dify YAML構造チェック ==="

# 1. 必須フィールドの存在確認
echo -n "1. app: フィールドチェック... "
grep -q "^app:" $FILE && echo "OK" || echo "NG: app:フィールドが見つかりません"

echo -n "2. workflow: フィールドチェック... "
grep -q "^workflow:" $FILE && echo "OK" || echo "NG: workflow:フィールドが見つかりません"

echo -n "3. graph: フィールドチェック... "
grep -q "graph:" $FILE && echo "OK" || echo "NG: graph:フィールドが見つかりません"

# 2. 比較演算子のチェック
echo -n "4. Unicode比較演算子チェック... "
if grep -E '"≥"|"≤"|"≠"' $FILE; then
    echo "NG: Unicode比較演算子が見つかりました。ASCII文字の使用を推奨"
else
    echo "OK"
fi

# 3. YAMLコメントチェック
echo -n "5. YAMLコメントチェック... "
if grep -E '^\s*#|[^"'\'']#' $FILE; then
    echo "NG: YAMLコメントが見つかりました。削除してください"
else
    echo "OK"
fi

# 4. isInLoopチェック
echo -n "6. isInLoopフィールドチェック... "
EDGE_COUNT=$(grep -c "edges:" $FILE)
IS_IN_LOOP_COUNT=$(grep -c "isInLoop:" $FILE)
if [ $EDGE_COUNT -eq $IS_IN_LOOP_COUNT ]; then
    echo "OK"
else
    echo "NG: すべてのエッジにisInLoopが設定されていません"
fi
```

## 実装例（Python）

```python
#!/usr/bin/env python3
import yaml
import sys
import re

def validate_dify_yaml(file_path):
    """Dify YAMLファイルの検証"""
    errors = []
    warnings = []
    
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
            data = yaml.safe_load(content)
    except Exception as e:
        return [f"YAMLパースエラー: {e}"], []
    
    # 必須フィールドチェック
    if 'app' not in data:
        errors.append("app:セクションが見つかりません")
    else:
        if 'use_icon_as_answer_icon' not in data['app']:
            errors.append("app.use_icon_as_answer_iconが見つかりません")
    
    if 'dependencies' not in data:
        errors.append("dependencies:が見つかりません")
    
    if 'kind' not in data or data['kind'] != 'app':
        errors.append("kind: appが見つかりません")
    
    if 'version' not in data or data['version'] != '0.3.0':
        errors.append("version: 0.3.0が見つかりません")
    
    # Unicode演算子チェック
    if re.search(r'[≥≤≠]', content):
        warnings.append("Unicode比較演算子が使用されています。ASCII文字（>=, <=, !=）の使用を推奨します")
    
    # YAMLコメントチェック
    if re.search(r'^\s*#|[^"\']#', content, re.MULTILINE):
        errors.append("YAMLコメントが含まれています。削除してください")
    
    # hashフィールドチェック
    if 'hash' in content:
        warnings.append("hashフィールドが含まれています。手動で追加しないでください")
    
    return errors, warnings

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("使用方法: python validate_dify.py <YAMLファイル>")
        sys.exit(1)
    
    errors, warnings = validate_dify_yaml(sys.argv[1])
    
    if errors:
        print("=== エラー ===")
        for error in errors:
            print(f"❌ {error}")
    
    if warnings:
        print("\n=== 警告 ===")
        for warning in warnings:
            print(f"⚠️  {warning}")
    
    if not errors and not warnings:
        print("✅ 検証に合格しました")
    
    sys.exit(1 if errors else 0)
```

## 出力形式

### エラー（修正必須）
```
❌ app.use_icon_as_answer_iconが見つかりません
❌ YAMLコメントが含まれています。削除してください
```

### 警告（推奨事項）
```
⚠️  Unicode比較演算子が使用されています。ASCII文字（>=, <=, !=）の使用を推奨します
⚠️  総ノード数が30個を超えています（現在: 35個）
```

### 成功
```
✅ 検証に合格しました
```

## 今後の拡張予定

1. **自動修正機能**
   - Unicode演算子のASCII変換
   - YAMLコメントの自動削除
   - 不足フィールドの自動追加

2. **詳細レポート**
   - ノードタイプ別の統計
   - 変数参照の依存関係グラフ
   - パフォーマンス予測

3. **IDE統合**
   - VSCode拡張機能
   - リアルタイム検証
   - 自動補完支援

## 更新履歴
- 2025-07-01: 初版作成