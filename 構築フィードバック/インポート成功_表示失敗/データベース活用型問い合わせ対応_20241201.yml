app:
  description: |
    å•†å“ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨é€£æºã—ã¦ã€åœ¨åº«æƒ…å ±ã‚„å•†å“è©³ç´°ã‚’å‚ç…§ã—ãªãŒã‚‰é¡§å®¢å•ã„åˆã‚ã›ã«å¯¾å¿œã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
    ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®åœ¨åº«çŠ¶æ³ã‚’åæ˜ ã—ã€æ­£ç¢ºãªæƒ…å ±æä¾›ã‚’å®Ÿç¾ã—ã¾ã™ã€‚
  icon: ğŸ—„ï¸
  icon_background: '#4A90E2'
  mode: advanced-chat
  name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ´»ç”¨å‹å•ã„åˆã‚ã›å¯¾å¿œã‚·ã‚¹ãƒ†ãƒ 
  use_icon_as_answer_icon: false
kind: app
version: 0.3.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
        - .PDF
        - .XLSX
        - .CSV
        - .TXT
      allowed_file_types:
        - document
      allowed_file_upload_methods:
        - local_file
      enabled: true
      number_limits: 3
    opening_statement: |
      ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ´»ç”¨å‹å•ã„åˆã‚ã›å¯¾å¿œã‚·ã‚¹ãƒ†ãƒ ã¸ã‚ˆã†ã“ãï¼
      
      ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ç¤¾å†…ã®å•†å“ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨é€£æºã—ã¦ã€ãŠå®¢æ§˜ã‹ã‚‰ã®å•ã„åˆã‚ã›ã«è¿…é€Ÿã‹ã¤æ­£ç¢ºã«å¯¾å¿œã—ã¾ã™ã€‚
      
      ä»¥ä¸‹ã®æƒ…å ±ã‚’ã”å…¥åŠ›ãã ã•ã„ï¼š
      - å•ã„åˆã‚ã›å†…å®¹
      - é¡§å®¢æƒ…å ±ï¼ˆä»»æ„ï¼‰
      - å•†å“ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯å•†å“åï¼ˆåˆ†ã‹ã‚‹å ´åˆï¼‰
      
      åœ¨åº«ç¢ºèªã€ç´æœŸç…§ä¼šã€å•†å“ä»•æ§˜ã®ç¢ºèªãªã©ã€å¹…åºƒã„å•ã„åˆã‚ã›ã«å¯¾å¿œå¯èƒ½ã§ã™ã€‚
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions:
      - 'SH-2000Aã®åœ¨åº«çŠ¶æ³ã¨ç´æœŸã‚’æ•™ãˆã¦ãã ã•ã„'
      - 'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯è£½ã®ç©ºæ°—æ¸…æµ„æ©Ÿã®ä»•æ§˜ä¸€è¦§ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'
      - 'å‹ç•ªABC-123ã®ä»£æ›¿å“ã‚’ææ¡ˆã—ã¦ãã ã•ã„'
      - 'éå»3ãƒ¶æœˆã®å•ã„åˆã‚ã›å±¥æ­´ã‚’ç¢ºèªã—ãŸã„'
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
  graph:
    edges:
      - id: start-extraction-edge
        source: start_node
        sourceHandle: source
        target: product_info_extraction_node
        targetHandle: target
        type: custom
      - id: extraction-db_query-edge
        source: product_info_extraction_node
        sourceHandle: source
        target: database_query_node
        targetHandle: target
        type: custom
      - id: db_query-validation-edge
        source: database_query_node
        sourceHandle: source
        target: data_validation_node
        targetHandle: target
        type: custom
      - id: validation-auto_answer-edge
        source: data_validation_node
        sourceHandle: 'true'
        target: auto_answer_generation_node
        targetHandle: target
        type: custom
      - id: validation-manufacturer_inquiry-edge
        source: data_validation_node
        sourceHandle: 'false'
        target: manufacturer_inquiry_node
        targetHandle: target
        type: custom
      - id: auto_answer-history-edge
        source: auto_answer_generation_node
        sourceHandle: source
        target: history_record_node
        targetHandle: target
        type: custom
      - id: manufacturer_inquiry-history-edge
        source: manufacturer_inquiry_node
        sourceHandle: source
        target: history_record_node
        targetHandle: target
        type: custom
      - id: history-answer-edge
        source: history_record_node
        sourceHandle: source
        target: answer_node
        targetHandle: target
        type: custom
    nodes:
      - data:
          desc: é¡§å®¢ã‹ã‚‰ã®å•ã„åˆã‚ã›ã‚’å—ã‘ä»˜ã‘ã¾ã™
          selected: false
          title: é–‹å§‹
          type: start
          variables:
            - label: å•ã„åˆã‚ã›å†…å®¹
              max_length: 2000
              options: []
              required: true
              type: paragraph
              variable: inquiry_content
            - label: é¡§å®¢æƒ…å ±
              max_length: 500
              options: []
              required: false
              type: text-input
              variable: customer_info
            - label: å•†å“ã‚³ãƒ¼ãƒ‰/å•†å“å
              max_length: 200
              options: []
              required: false
              type: text-input
              variable: product_identifier
        height: 180
        id: start_node
        position:
          x: 50
          y: 250
        selected: false
        sourcePosition: right
        targetPosition: left
        type: start
        width: 244
      - data:
          context:
            enabled: false
            variable_selector: []
          desc: å•ã„åˆã‚ã›æ–‡ã‹ã‚‰å•†å“æƒ…å ±ã‚’æŠ½å‡º
          memory:
            query_prompt_template: ''
            role_prefix:
              assistant: ''
              user: ''
            window:
              enabled: false
              size: 10
          model:
            completion_params:
              temperature: 0.2
            mode: chat
            name: gpt-4o-mini
            provider: openai
          prompt_template:
            - edition_type: basic
              id: 19d3dc59-fa93-4a1f-a063-9a1e16461cd9
              role: system
              text: |
                ã‚ãªãŸã¯å•†å“æƒ…å ±æŠ½å‡ºã®å°‚é–€å®¶ã§ã™ã€‚
                å•ã„åˆã‚ã›æ–‡ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æ­£ç¢ºã«æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š
                1. ãƒ¡ãƒ¼ã‚«ãƒ¼å
                2. å•†å“åã¾ãŸã¯å‹ç•ª
                3. å•ã„åˆã‚ã›ç¨®åˆ¥ï¼ˆåœ¨åº«ç¢ºèª/ä»•æ§˜ç¢ºèª/ç´æœŸç¢ºèª/ãã®ä»–ï¼‰
                
                JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
            - edition_type: basic
              id: 44a09c6f-4e0f-4e4f-8c4f-f4c4c6f4c4c4
              role: user
              text: |
                å•ã„åˆã‚ã›å†…å®¹ï¼š{{#start_node.inquiry_content#}}
                å•†å“ã‚³ãƒ¼ãƒ‰/å•†å“åï¼š{{#start_node.product_identifier#}}
          selected: false
          title: å•†å“æƒ…å ±æŠ½å‡º
          type: llm
          variables: []
          vision:
            configs:
              detail: high
            enabled: false
        height: 98
        id: product_info_extraction_node
        position:
          x: 350
          y: 250
        selected: false
        sourcePosition: right
        targetPosition: left
        type: llm
        width: 244
      - data:
          code: |
            import json
            import random
            from datetime import datetime, timedelta

            # æŠ½å‡ºã•ã‚ŒãŸå•†å“æƒ…å ±ã‚’è§£æ
            try:
                product_info = json.loads(product_info_json)
            except:
                product_info = {
                    "manufacturer": "ä¸æ˜",
                    "product_name": product_identifier,
                    "inquiry_type": "åœ¨åº«ç¢ºèª"
                }

            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼šã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹APIã‚’å‘¼ã³å‡ºã™
            
            # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆå®Ÿéš›ã¯DBã‹ã‚‰å–å¾—ï¼‰
            sample_db = {
                "SH-2000A": {
                    "manufacturer": "ã‚·ãƒ£ãƒ¼ãƒ—",
                    "product_name": "ç©ºæ°—æ¸…æµ„æ©Ÿ SH-2000A",
                    "stock": 15,
                    "price": 45000,
                    "next_arrival": (datetime.now() + timedelta(days=7)).strftime("%Y-%m-%d"),
                    "specifications": {
                        "é©ç”¨åºŠé¢ç©": "ï½25ç•³",
                        "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¯¿å‘½": "ç´„10å¹´",
                        "æ¶ˆè²»é›»åŠ›": "æœ€å¤§50W",
                        "ã‚µã‚¤ã‚º": "å¹…395Ã—å¥¥è¡Œ265Ã—é«˜ã•540mm"
                    }
                },
                "ABC-123": {
                    "manufacturer": "ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯",
                    "product_name": "é™¤æ¹¿æ©Ÿ ABC-123",
                    "stock": 0,
                    "price": 38000,
                    "next_arrival": (datetime.now() + timedelta(days=14)).strftime("%Y-%m-%d"),
                    "specifications": {
                        "é™¤æ¹¿èƒ½åŠ›": "12L/æ—¥",
                        "ã‚¿ãƒ³ã‚¯å®¹é‡": "3.5L",
                        "æ¶ˆè²»é›»åŠ›": "300W",
                        "ã‚µã‚¤ã‚º": "å¹…365Ã—å¥¥è¡Œ202Ã—é«˜ã•565mm"
                    }
                }
            }

            # å•†å“æ¤œç´¢
            product_code = product_info.get("product_name", product_identifier)
            db_result = None
            
            for code, data in sample_db.items():
                if code in str(product_code) or str(product_code) in data["product_name"]:
                    db_result = data
                    db_result["product_code"] = code
                    break

            # æ¤œç´¢çµæœã®è¿”å´
            if db_result:
                result = {
                    "found": True,
                    "data": db_result,
                    "inquiry_type": product_info.get("inquiry_type", "åœ¨åº«ç¢ºèª"),
                    "timestamp": datetime.now().isoformat()
                }
            else:
                result = {
                    "found": False,
                    "data": None,
                    "inquiry_type": product_info.get("inquiry_type", "åœ¨åº«ç¢ºèª"),
                    "timestamp": datetime.now().isoformat()
                }

            return {
                "db_result": json.dumps(result, ensure_ascii=False),
                "data_found": result["found"]
            }
          code_language: python3
          desc: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å•†å“æƒ…å ±ã‚’å–å¾—
          outputs:
            db_result:
              children: null
              type: string
            data_found:
              children: null
              type: boolean
          selected: false
          title: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼š
          type: code
          variables:
            - value_selector:
                - product_info_extraction_node
                - text
              variable: product_info_json
            - value_selector:
                - start_node
                - product_identifier
              variable: product_identifier
        height: 82
        id: database_query_node
        position:
          x: 650
          y: 250
        selected: false
        sourcePosition: right
        targetPosition: left
        type: code
        width: 244
      - data:
          cases:
            - case_id: 'true'
              conditions:
                - comparison_operator: is
                  id: bd2b8110-c6a7-4c8f-93e2-c6c5b5b5b5b5
                  value: 'true'
                  variable_selector:
                    - database_query_node
                    - data_found
              id: 'true'
              logical_operator: and
          default_case_id: 'false'
          desc: ãƒ‡ãƒ¼ã‚¿ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª
          selected: false
          title: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
          type: if-else
        height: 134
        id: data_validation_node
        position:
          x: 950
          y: 250
        selected: false
        sourcePosition: right
        targetPosition: left
        type: if-else
        width: 244
      - data:
          context:
            enabled: false
            variable_selector: []
          desc: DBæƒ…å ±ã‚’åŸºã«è‡ªå‹•å›ç­”ã‚’ç”Ÿæˆ
          memory:
            query_prompt_template: ''
            role_prefix:
              assistant: ''
              user: ''
            window:
              enabled: false
              size: 10
          model:
            completion_params:
              temperature: 0.3
            mode: chat
            name: gpt-4o-mini
            provider: openai
          prompt_template:
            - edition_type: basic
              id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
              role: system
              text: |
                ã‚ãªãŸã¯ä¸å¯§ãªå•†å“å•ã„åˆã‚ã›å¯¾å¿œã®å°‚é–€å®¶ã§ã™ã€‚
                ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã‚’åŸºã«ã€ãŠå®¢æ§˜ã«åˆ†ã‹ã‚Šã‚„ã™ãå›ç­”ã—ã¦ãã ã•ã„ã€‚
                
                å›ç­”ã«ã¯ä»¥ä¸‹ã‚’å«ã‚ã¦ãã ã•ã„ï¼š
                - å•†å“ã®æ­£å¼åç§°
                - åœ¨åº«çŠ¶æ³ï¼ˆå…·ä½“çš„ãªæ•°é‡ï¼‰
                - ç´æœŸæƒ…å ±
                - ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰
                - å¿…è¦ã«å¿œã˜ã¦å•†å“ä»•æ§˜
                
                ä¸å¯§ã§è¦ªã—ã¿ã‚„ã™ã„å£èª¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
            - edition_type: basic
              id: b2c3d4e5-f6a7-890b-cdef-234567890abc
              role: user
              text: |
                å•ã„åˆã‚ã›å†…å®¹ï¼š{{#start_node.inquiry_content#}}
                é¡§å®¢æƒ…å ±ï¼š{{#start_node.customer_info#}}
                
                ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢çµæœï¼š
                {{#database_query_node.db_result#}}
          selected: false
          title: è‡ªå‹•å›ç­”ç”Ÿæˆ
          type: llm
          variables: []
          vision:
            configs:
              detail: high
            enabled: false
        height: 98
        id: auto_answer_generation_node
        position:
          x: 1250
          y: 150
        selected: false
        sourcePosition: right
        targetPosition: left
        type: llm
        width: 244
      - data:
          context:
            enabled: false
            variable_selector: []
          desc: ãƒ¡ãƒ¼ã‚«ãƒ¼ã¸ã®å•ã„åˆã‚ã›æ–‡ã‚’ç”Ÿæˆ
          memory:
            query_prompt_template: ''
            role_prefix:
              assistant: ''
              user: ''
            window:
              enabled: false
              size: 10
          model:
            completion_params:
              temperature: 0.3
            mode: chat
            name: gpt-4o-mini
            provider: openai
          prompt_template:
            - edition_type: basic
              id: c3d4e5f6-a789-0bcd-ef12-345678901234
              role: system
              text: |
                ã‚ãªãŸã¯å•ã„åˆã‚ã›å¯¾å¿œã®å°‚é–€å®¶ã§ã™ã€‚
                ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å•†å“æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®å¯¾å¿œã‚’è¡Œã„ã¾ã™ã€‚
                
                ä»¥ä¸‹ã®2ã¤ã®æ–‡ç« ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
                1. ãŠå®¢æ§˜å‘ã‘ï¼šç¢ºèªä¸­ã§ã‚ã‚‹æ—¨ã®ä¸å¯§ãªæ¡ˆå†…æ–‡
                2. ãƒ¡ãƒ¼ã‚«ãƒ¼å‘ã‘ï¼šå…·ä½“çš„ãªæƒ…å ±æä¾›ä¾é ¼æ–‡
                
                JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
                {
                  "customer_response": "ãŠå®¢æ§˜å‘ã‘ã®æ–‡ç« ",
                  "manufacturer_inquiry": "ãƒ¡ãƒ¼ã‚«ãƒ¼å‘ã‘ã®æ–‡ç« "
                }
            - edition_type: basic
              id: d4e5f6a7-890b-cdef-1234-567890abcdef
              role: user
              text: |
                å•ã„åˆã‚ã›å†…å®¹ï¼š{{#start_node.inquiry_content#}}
                é¡§å®¢æƒ…å ±ï¼š{{#start_node.customer_info#}}
                å•†å“è­˜åˆ¥æƒ…å ±ï¼š{{#start_node.product_identifier#}}
                
                æŠ½å‡ºã•ã‚ŒãŸæƒ…å ±ï¼š
                {{#product_info_extraction_node.text#}}
          selected: false
          title: ãƒ¡ãƒ¼ã‚«ãƒ¼å•ã„åˆã‚ã›ç”Ÿæˆ
          type: llm
          variables: []
          vision:
            configs:
              detail: high
            enabled: false
        height: 98
        id: manufacturer_inquiry_node
        position:
          x: 1250
          y: 350
        selected: false
        sourcePosition: right
        targetPosition: left
        type: llm
        width: 244
      - data:
          code: |
            import json
            from datetime import datetime

            # å±¥æ­´è¨˜éŒ²ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²ã‚’ä¿å­˜

            history_entry = {
                "timestamp": datetime.now().isoformat(),
                "inquiry_content": inquiry_content,
                "customer_info": customer_info,
                "product_identifier": product_identifier,
                "response_type": "auto_response" if auto_response else "manufacturer_inquiry",
                "response_content": auto_response if auto_response else manufacturer_response,
                "db_result": db_result if db_result else None
            }

            # ãƒ­ã‚°å‡ºåŠ›ï¼ˆå®Ÿéš›ã¯DBä¿å­˜ï¼‰
            print(f"å±¥æ­´è¨˜éŒ²: {json.dumps(history_entry, ensure_ascii=False, indent=2)}")

            # æœ€çµ‚çš„ãªå›ç­”ã‚’æ•´å½¢
            if auto_response:
                final_response = auto_response
            else:
                try:
                    inquiry_data = json.loads(manufacturer_response)
                    final_response = inquiry_data.get("customer_response", manufacturer_response)
                except:
                    final_response = manufacturer_response

            return {
                "final_response": final_response,
                "history_saved": True,
                "record_id": f"INQ-{datetime.now().strftime('%Y%m%d%H%M%S')}"
            }
          code_language: python3
          desc: å•ã„åˆã‚ã›ã¨å›ç­”ã‚’å±¥æ­´ã«è¨˜éŒ²
          outputs:
            final_response:
              children: null
              type: string
            history_saved:
              children: null
              type: boolean
            record_id:
              children: null
              type: string
          selected: false
          title: å±¥æ­´è¨˜éŒ²
          type: code
          variables:
            - value_selector:
                - start_node
                - inquiry_content
              variable: inquiry_content
            - value_selector:
                - start_node
                - customer_info
              variable: customer_info
            - value_selector:
                - start_node
                - product_identifier
              variable: product_identifier
            - value_selector:
                - auto_answer_generation_node
                - text
              variable: auto_response
            - value_selector:
                - manufacturer_inquiry_node
                - text
              variable: manufacturer_response
            - value_selector:
                - database_query_node
                - db_result
              variable: db_result
        height: 82
        id: history_record_node
        position:
          x: 1550
          y: 250
        selected: false
        sourcePosition: right
        targetPosition: left
        type: code
        width: 244
      - data:
          answer: |
            {{#history_record_node.final_response#}}

            ---
            å¯¾å¿œè¨˜éŒ²ç•ªå·: {{#history_record_node.record_id#}}
          desc: æœ€çµ‚çš„ãªå›ç­”ã‚’å‡ºåŠ›
          selected: false
          title: å›ç­”å‡ºåŠ›
          type: answer
          variables: []
        height: 105
        id: answer_node
        position:
          x: 1850
          y: 250
        selected: false
        sourcePosition: right
        targetPosition: left
        type: answer
        width: 244
