app:
  name: "å—ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«è¦ç´„â†’åœ¨åº«æ›´æ–°ãƒªã‚¹ãƒˆç”Ÿæˆãƒœãƒƒãƒˆ"
  description: "å—ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ç™ºæ³¨æƒ…å ±ã‚’æŠ½å‡ºã—ã€åœ¨åº«æ›´æ–°ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒœãƒƒãƒˆ"
  icon: "ğŸ“§"
  icon_background: "#4A90E2"
  mode: "advanced-chat"
  use_icon_as_answer_icon: false

dependencies: []

kind: "app"

version: "0.3.0"

workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      enabled: true
      max_size: 10
      allowed_types:
        - "txt"
        - "pdf"
    opening_statement: "å—ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ç™ºæ³¨æƒ…å ±ã‚’æŠ½å‡ºã—ã¦åœ¨åº«æ›´æ–°ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚"
    suggested_questions:
      - "ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒ¼ãƒ«ã§è©¦ã—ã¦ã¿ã‚‹"
      - "CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å‡ºåŠ›ã™ã‚‹"
      - "å¤‰æ›´ç‚¹ã®ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹"
    retriever_resource:
      enabled: false
  graph:
    nodes:
      - id: "start"
        type: "start"
        position:
          x: 100
          y: 300
        data:
          title: "é–‹å§‹"
          type: "start"
          variables: []
      
      - id: "llm_mail_parser"
        type: "llm"
        position:
          x: 400
          y: 300
        data:
          title: "ãƒ¡ãƒ¼ãƒ«è§£æ"
          type: "llm"
          model:
            provider: "openai"
            name: "gpt-4-turbo-preview"
            mode: "chat"
            completion_params:
              temperature: 0.3
              max_tokens: 2000
          prompt_template:
            - id: "system"
              role: "system"
              text: |
                ã‚ãªãŸã¯å—ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ç™ºæ³¨æƒ…å ±ã‚’æ­£ç¢ºã«æŠ½å‡ºã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
                
                ä»¥ä¸‹ã®å•†å“ãƒã‚¹ã‚¿ã‚’å‚ç…§ã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ç™ºæ³¨æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š
                
                ã€å•†å“ãƒã‚¹ã‚¿ã€‘
                SKU,å“å,å˜ä½,ã‚«ãƒ†ã‚´ãƒª
                A001,M8å…­è§’ãƒœãƒ«ãƒˆSUS304,æœ¬,ãƒœãƒ«ãƒˆ
                A002,M10å…­è§’ãƒœãƒ«ãƒˆSUS304,æœ¬,ãƒœãƒ«ãƒˆ
                B001,ãƒ¯ãƒƒã‚·ãƒ£ãƒ¼M8,æš,ãƒ¯ãƒƒã‚·ãƒ£ãƒ¼
                B002,ãƒ¯ãƒƒã‚·ãƒ£ãƒ¼M10,æš,ãƒ¯ãƒƒã‚·ãƒ£ãƒ¼
                C001,ã‚¹ãƒ—ãƒªãƒ³ã‚°ãƒ¯ãƒƒã‚·ãƒ£ãƒ¼M8,æš,ãƒ¯ãƒƒã‚·ãƒ£ãƒ¼
                D001,å…­è§’ãƒŠãƒƒãƒˆM8,å€‹,ãƒŠãƒƒãƒˆ
                D002,å…­è§’ãƒŠãƒƒãƒˆM10,å€‹,ãƒŠãƒƒãƒˆ
                E001,ã‚¢ãƒ«ãƒŸæ¿æ1000Ã—2000Ã—3t,æš,æ¿æ
                E002,SUS304æ¿æ1000Ã—2000Ã—2t,æš,æ¿æ
                F001,ä¸¸é‹¼SS400Ï†20Ã—4000,æœ¬,æ£’æ
                
                ã€ç´æœŸè¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘
                å³ç´â†’å½“æ—¥
                ç¿Œæ—¥ãƒ»æ˜æ—¥â†’ç¿Œå–¶æ¥­æ—¥
                â—‹æ—¥å¾Œâ†’â—‹å–¶æ¥­æ—¥å¾Œ
                æ¥é€±â†’5å–¶æ¥­æ—¥å¾Œ
                ä»Šé€±ä¸­â†’3å–¶æ¥­æ—¥å¾Œ
                è‡³æ€¥ãƒ»ASAPâ†’ç¿Œå–¶æ¥­æ—¥
                
                å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§JSONå‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
                {
                  "orders": [
                    {
                      "sku": "SKUã‚³ãƒ¼ãƒ‰",
                      "product_name": "å“å",
                      "quantity": æ•°é‡,
                      "unit": "å˜ä½",
                      "delivery_date": "æ¨™æº–åŒ–ã•ã‚ŒãŸç´æœŸ"
                    }
                  ],
                  "summary": "ç™ºæ³¨å†…å®¹ã®è¦ç´„",
                  "notes": "å‚™è€ƒãƒ»ç‰¹è¨˜äº‹é …"
                }
            - id: "user"
              role: "user"
              text: "{{#sys.query#}}"
          memory:
            enabled: false
          structured_output_enabled: false
          vision:
            enabled: false
          outputs:
            text: "ç™ºæ³¨æƒ…å ±JSON"
      
      - id: "code_json_to_csv"
        type: "code"
        position:
          x: 700
          y: 300
        data:
          title: "JSONâ†’CSVå¤‰æ›"
          type: "code"
          variables:
            - variable: "json_data"
              value_selector:
                - "llm_mail_parser"
                - "text"
          code: |
            import json
            from datetime import datetime
            
            # JSONæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
            try:
                data = json.loads(json_data)
            except:
                return {"csv_data": "ã‚¨ãƒ©ãƒ¼: JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ", "summary": "", "notes": ""}
            
            # åœ¨åº«ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
            inventory = {
                "A001": {"current": 5000, "updated": 5000},
                "A002": {"current": 3000, "updated": 3000},
                "B001": {"current": 10000, "updated": 10000},
                "B002": {"current": 8000, "updated": 8000},
                "C001": {"current": 7000, "updated": 7000},
                "D001": {"current": 6000, "updated": 6000},
                "D002": {"current": 4000, "updated": 4000},
                "E001": {"current": 50, "updated": 50},
                "E002": {"current": 30, "updated": 30},
                "F001": {"current": 100, "updated": 100}
            }
            
            # CSVè¡Œã‚’ç”Ÿæˆ
            csv_lines = []
            for order in data.get("orders", []):
                sku = order.get("sku", "")
                if sku in inventory:
                    inventory[sku]["updated"] += order.get("quantity", 0)
                csv_line = f"{sku},{order.get('product_name', '')},{order.get('quantity', '')},{order.get('unit', '')},{order.get('delivery_date', '')},{inventory.get(sku, {}).get('current', '')},{inventory.get(sku, {}).get('updated', '')}"
                csv_lines.append(csv_line)
            
            return {
                "csv_data": "\n".join(csv_lines),
                "summary": data.get("summary", ""),
                "notes": data.get("notes", ""),
                "current_time": datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
          outputs:
            csv_data: "CSVå½¢å¼ã®ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿"
            summary: "ç™ºæ³¨å†…å®¹ã®è¦ç´„"
            notes: "å‚™è€ƒ"
            current_time: "ç¾åœ¨æ™‚åˆ»"
      
      - id: "template_transform_inventory"
        type: "template-transform"
        position:
          x: 1000
          y: 300
        data:
          title: "åœ¨åº«æ›´æ–°ãƒªã‚¹ãƒˆç”Ÿæˆ"
          type: "template-transform"
          variables:
            - variable: "csv_data"
              value_selector:
                - "code_json_to_csv"
                - "csv_data"
            - variable: "summary"
              value_selector:
                - "code_json_to_csv"
                - "summary"
            - variable: "notes"
              value_selector:
                - "code_json_to_csv"
                - "notes"
            - variable: "current_time"
              value_selector:
                - "code_json_to_csv"
                - "current_time"
          template: |
            ## åœ¨åº«æ›´æ–°ãƒªã‚¹ãƒˆ

            ç™ºæ³¨æ—¥æ™‚: {{ current_time }}

            ### ç™ºæ³¨å†…å®¹ã‚µãƒãƒªãƒ¼
            {{ summary }}

            ### ç™ºæ³¨æ˜ç´°ï¼ˆCSVå½¢å¼ï¼‰
            ```csv
            SKU,å“å,ç™ºæ³¨æ•°é‡,å˜ä½,ç´æœŸ,æ›´æ–°å‰åœ¨åº«,æ›´æ–°å¾Œåœ¨åº«
            {{ csv_data }}
            ```

            ### å‚™è€ƒãƒ»ç‰¹è¨˜äº‹é …
            {{ notes }}

            ### å¤‰æ›´ç‚¹ã‚µãƒãƒªãƒ¼
            - ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«å‡¦ç†ã—ã¾ã—ãŸ
            - åœ¨åº«æ•°é‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ
            - ç™ºæ³¨ç¢ºèªãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ

            ### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            1. åœ¨åº«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ ã¸ã®åæ˜ 
            3. ä»•å…¥å…ˆã¸ã®ç™ºæ³¨æ›¸é€ä»˜
          outputs:
            output: "åœ¨åº«æ›´æ–°ãƒªã‚¹ãƒˆ"
      
      - id: "answer"
        type: "answer"
        position:
          x: 1300
          y: 300
        data:
          title: "çµæœå‡ºåŠ›"
          type: "answer"
          answer: "{{#template_transform_inventory.output#}}"
    
    edges:
      - id: "edge_1"
        source: "start"
        target: "llm_mail_parser"
        data:
          sourceType: "start"
          targetType: "llm"
          isInLoop: false
      
      - id: "edge_2"
        source: "llm_mail_parser"
        target: "code_json_to_csv"
        data:
          sourceType: "llm"
          targetType: "code"
          isInLoop: false
      
      - id: "edge_3"
        source: "code_json_to_csv"
        target: "template_transform_inventory"
        data:
          sourceType: "code"
          targetType: "template-transform"
          isInLoop: false
      
      - id: "edge_4"
        source: "template_transform_inventory"
        target: "answer"
        data:
          sourceType: "template-transform"
          targetType: "answer"
          isInLoop: false