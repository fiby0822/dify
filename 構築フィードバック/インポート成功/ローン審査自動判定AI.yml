app:
  description: ローン申込書を自動解析し、多段階審査により承認可否を判定する金融AIシステム
  icon: 💳
  icon_background: '#059669'
  mode: advanced-chat
  name: ローン審査自動判定AI
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/openai:0.0.26@c1e643ac6a7732f6333a783320b4d3026fa5e31d8e7026375b98d44418d33f26
kind: app
version: 0.3.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .PDF
      - .DOC
      - .DOCX
      - .TXT
      allowed_file_types:
      - document
      allowed_file_upload_methods:
      - local_file
      enabled: true
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: 'こんにちは！ローン審査自動判定AIです。


      💼 ローン申込書をアップロードしてください

      📊 審査種別をお選びください


      以下の審査を自動実行します：

      ✅ 申込情報の自動抽出・検証

      📈 信用スコアの自動算出

      💰 返済能力の詳細分析

      ⚖️ リスク評価・総合判定

      📋 承認可否の明確な結果表示


      【対応ローン種別】

      🏠 住宅ローン / 🚗 自動車ローン / 💼 事業資金ローン

      '
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions:
    - 住宅ローンの審査をお願いします
    - 自動車ローンの可否判定をしてください
    - 事業資金ローンの審査をお願いします
    suggested_questions_after_answer:
      enabled: true
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInLoop: false
        sourceType: start
        targetType: if-else
      id: start-filecheck-edge
      selected: false
      source: start_node
      sourceHandle: source
      target: file_check_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: answer
      id: filecheck-nofile-edge
      selected: false
      source: file_check_node
      sourceHandle: 'true'
      target: no_file_answer
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: document-extractor
      id: filecheck-extract-edge
      selected: false
      source: file_check_node
      sourceHandle: 'false'
      target: document_extract_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: document-extractor
        targetType: parameter-extractor
      id: doc-param-edge
      selected: false
      source: document_extract_node
      sourceHandle: source
      target: data_extract_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: parameter-extractor
        targetType: code
      id: param-validation-edge
      selected: false
      source: data_extract_node
      sourceHandle: source
      target: data_validation_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: if-else
      id: validation-loantype-edge
      selected: false
      source: data_validation_node
      sourceHandle: source
      target: loan_type_check_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: loantype-housing-edge
      selected: false
      source: loan_type_check_node
      sourceHandle: housing_loan
      target: housing_loan_analysis_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: loantype-auto-edge
      selected: false
      source: loan_type_check_node
      sourceHandle: auto_loan
      target: auto_loan_analysis_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: loantype-business-edge
      selected: false
      source: loan_type_check_node
      sourceHandle: business_loan
      target: business_loan_analysis_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: housing-scoring-edge
      selected: false
      source: housing_loan_analysis_node
      sourceHandle: source
      target: credit_scoring_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: auto-scoring-edge
      selected: false
      source: auto_loan_analysis_node
      sourceHandle: source
      target: credit_scoring_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: business-scoring-edge
      selected: false
      source: business_loan_analysis_node
      sourceHandle: source
      target: credit_scoring_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: if-else
      id: scoring-decision-edge
      selected: false
      source: credit_scoring_node
      sourceHandle: source
      target: final_decision_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: decision-approved-edge
      selected: false
      source: final_decision_node
      sourceHandle: approved
      target: approval_report_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: decision-conditional-edge
      selected: false
      source: final_decision_node
      sourceHandle: conditional
      target: conditional_report_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: decision-rejected-edge
      selected: false
      source: final_decision_node
      sourceHandle: rejected
      target: rejection_report_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: answer
      id: approved-answer-edge
      selected: false
      source: approval_report_node
      sourceHandle: source
      target: final_answer_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: answer
      id: conditional-answer-edge
      selected: false
      source: conditional_report_node
      sourceHandle: source
      target: final_answer_node
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: answer
      id: rejected-answer-edge
      selected: false
      source: rejection_report_node
      sourceHandle: source
      target: final_answer_node
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: 'ローン申込書と審査種別をお教えください。

          自動審査により承認可否を判定いたします。

          '
        selected: false
        title: 開始
        type: start
        variables:
        - allowed_file_extensions:
          - .PDF
          - .DOC
          - .DOCX
          - .TXT
          allowed_file_types:
          - document
          allowed_file_upload_methods:
          - local_file
          label: ローン申込書
          max_length: 3
          options: []
          required: true
          type: file
          variable: application_file
        - label: 審査種別
          max_length: 50
          options:
          - 住宅ローン
          - 自動車ローン
          - 事業資金ローン
          required: true
          type: select
          variable: loan_type
        - label: 希望借入金額（万円）
          max_length: 20
          options: []
          required: true
          type: text-input
          variable: loan_amount
      height: 218
      id: start_node
      position:
        x: 50
        y: 100
      positionAbsolute:
        x: 50
        y: 100
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: not exists
            id: file_check_condition
            value: ''
            varType: file
            variable_selector:
            - start_node
            - application_file
          id: 'true'
          logical_operator: and
        desc: ローン申込書アップロードの確認
        selected: false
        title: ファイル存在チェック
        type: if-else
      height: 154
      id: file_check_node
      position:
        x: 350
        y: 100
      positionAbsolute:
        x: 350
        y: 100
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        answer: '❌ ローン申込書がアップロードされていません。


          📄 以下の形式のファイルをアップロードしてください：

          • PDF申込書 (.pdf)

          • Word文書 (.doc, .docx)

          • テキストファイル (.txt)


          💼 対応可能な申込書：

          • 住宅ローン申込書

          • 自動車ローン申込書

          • 事業資金ローン申込書

          • 所得証明書、源泉徴収票


          ファイルをアップロード後、再度実行してください。

          '
        desc: ''
        selected: false
        title: ファイル未アップロード
        type: answer
        variables: []
      height: 246
      id: no_file_answer
      position:
        x: 650
        y: 30
      positionAbsolute:
        x: 650
        y: 30
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: PDF/Word申込書からテキストを抽出
        is_array_file: false
        selected: false
        title: 申込書文書抽出
        type: document-extractor
        variable_selector:
        - start_node
        - application_file
      height: 120
      id: document_extract_node
      position:
        x: 650
        y: 200
      positionAbsolute:
        x: 650
        y: 200
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: 申込書から構造化データを抽出
        instruction: 'ローン申込書の情報を分析し、以下の項目を正確に抽出してください。

          金融審査に必要な情報を重点的に抽出し、数値は単位も含めて記録してください。

          '
        model:
          completion_params:
            temperature: 0.05
          mode: chat
          name: gpt-4
          provider: langgenius/openai/openai
        parameters:
        - description: 申込者氏名
          name: applicant_name
          required: false
          type: string
        - description: 年齢（数値のみ）
          name: age
          required: false
          type: number
        - description: 年収（万円、数値のみ）
          name: annual_income
          required: false
          type: number
        - description: 勤務先企業名
          name: employer
          required: false
          type: string
        - description: 勤続年数（年、数値のみ）
          name: employment_years
          required: false
          type: number
        - description: 雇用形態（正社員/契約社員/派遣/自営業等）
          name: employment_type
          required: false
          type: string
        - description: 既存借入額（万円、数値のみ）
          name: existing_debt
          required: false
          type: number
        - description: 月収（万円、数値のみ）
          name: monthly_income
          required: false
          type: number
        - description: 家族構成（配偶者有無、扶養家族数）
          name: family_status
          required: false
          type: string
        - description: 居住形態（持家/賃貸/その他）
          name: housing_status
          required: false
          type: string
        - description: 担保の有無（有/無）
          name: collateral
          required: false
          type: string
        query:
        - document_extract_node
        - text
        reasoning_mode: prompt
        selected: false
        title: 申込情報抽出
        type: parameter-extractor
        variables: []
        vision:
          enabled: false
      height: 118
      id: data_extract_node
      position:
        x: 950
        y: 150
      positionAbsolute:
        x: 950
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "def main(applicant_name: str, age: int, annual_income: int, monthly_income:\
          \ int,\n         employment_years: int, employment_type: str, existing_debt:\
          \ int,\n         loan_amount: str, loan_type: str) -> dict:\n    \"\"\"\n\
          \    申込データの妥当性検証とクリーニング\n    \"\"\"\n    \n    # 希望借入金額の数値化\n    try:\n\
          \        loan_amount_num = float(str(loan_amount).replace('万円', '').replace(',',\
          \ ''))\n    except:\n        loan_amount_num = 0\n    \n    # データ妥当性チェック\n\
          \    validation_errors = []\n    \n    # 必須項目チェック\n    if not applicant_name\
          \ or applicant_name == \"不明\":\n        validation_errors.append(\"申込者氏名が不明\"\
          )\n    \n    if not age or age <= 0 or age > 100:\n        validation_errors.append(\"\
          年齢情報が不正\")\n    \n    if not annual_income or annual_income <= 0:\n    \
          \    validation_errors.append(\"年収情報が不明または不正\")\n    \n    # 年収と月収の整合性チェック\n\
          \    if annual_income and monthly_income:\n        expected_monthly = annual_income\
          \ / 12\n        if abs(monthly_income - expected_monthly) > expected_monthly\
          \ * 0.5:\n            validation_errors.append(\"年収と月収の整合性に問題\")\n    \n\
          \    # 返済比率の計算\n    if annual_income > 0 and loan_amount_num > 0:\n    \
          \    # 簡易返済比率計算（金利3%、35年返済と仮定）\n        monthly_payment = loan_amount_num\
          \ * 10000 * 0.03 / 12 * 1.2  # 概算\n        monthly_income_calc = annual_income\
          \ / 12\n        payment_ratio = (monthly_payment / (monthly_income_calc\
          \ * 10000)) * 100\n    else:\n        payment_ratio = 0\n    \n    # 信用リスク要因の特定\n\
          \    risk_factors = []\n    \n    if existing_debt and existing_debt > annual_income\
          \ * 0.3:\n        risk_factors.append(\"既存借入が年収の30%超\")\n    \n    if employment_years\
          \ and employment_years < 1:\n        risk_factors.append(\"勤続年数1年未満\")\n\
          \    \n    if employment_type and employment_type in [\"派遣\", \"契約社員\",\
          \ \"アルバイト\"]:\n        risk_factors.append(\"非正規雇用\")\n    \n    if payment_ratio\
          \ > 35:\n        risk_factors.append(\"返済比率35%超\")\n    \n    # 総合妥当性判定\n\
          \    if len(validation_errors) == 0:\n        data_quality = \"良好\"\n  \
          \  elif len(validation_errors) <= 2:\n        data_quality = \"要注意\"\n \
          \   else:\n        data_quality = \"不良\"\n    \n    return {\n        \"\
          validation_errors\": validation_errors,\n        \"risk_factors\": risk_factors,\n\
          \        \"payment_ratio\": round(payment_ratio, 1) if payment_ratio > 0\
          \ else 0,\n        \"loan_amount_processed\": loan_amount_num,\n       \
          \ \"data_quality\": data_quality,\n        \"error_count\": len(validation_errors),\n\
          \        \"risk_count\": len(risk_factors)\n    }\n"
        code_language: python3
        desc: 申込データの妥当性検証
        error_strategy: fail-branch
        outputs:
          data_quality:
            children: null
            type: string
          error_count:
            children: null
            type: number
          loan_amount_processed:
            children: null
            type: number
          payment_ratio:
            children: null
            type: number
          risk_count:
            children: null
            type: number
          risk_factors:
            children: null
            type: array[string]
          validation_errors:
            children: null
            type: array[string]
        selected: false
        title: データ妥当性検証
        type: code
        variables:
        - value_selector:
          - data_extract_node
          - applicant_name
          variable: applicant_name
        - value_selector:
          - data_extract_node
          - age
          variable: age
        - value_selector:
          - data_extract_node
          - annual_income
          variable: annual_income
        - value_selector:
          - data_extract_node
          - monthly_income
          variable: monthly_income
        - value_selector:
          - data_extract_node
          - employment_years
          variable: employment_years
        - value_selector:
          - data_extract_node
          - employment_type
          variable: employment_type
        - value_selector:
          - data_extract_node
          - existing_debt
          variable: existing_debt
        - value_selector:
          - start_node
          - loan_amount
          variable: loan_amount
        - value_selector:
          - start_node
          - loan_type
          variable: loan_type
      height: 118
      id: data_validation_node
      position:
        x: 1250
        y: 150
      positionAbsolute:
        x: 1250
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        cases:
        - case_id: housing_loan
          conditions:
          - comparison_operator: contains
            id: housing_condition
            value: 住宅
            varType: string
            variable_selector:
            - start_node
            - loan_type
          id: housing_loan
          logical_operator: and
        - case_id: auto_loan
          conditions:
          - comparison_operator: contains
            id: auto_condition
            value: 自動車
            varType: string
            variable_selector:
            - start_node
            - loan_type
          id: auto_loan
          logical_operator: and
        - case_id: business_loan
          conditions:
          - comparison_operator: contains
            id: business_condition
            value: 事業
            varType: string
            variable_selector:
            - start_node
            - loan_type
          id: business_loan
          logical_operator: and
        desc: ローン種別による審査ルート分岐
        selected: false
        title: ローン種別判定
        type: if-else
      height: 250
      id: loan_type_check_node
      position:
        x: 1550
        y: 100
      positionAbsolute:
        x: 1550
        y: 100
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 住宅ローン専門審査
        model:
          completion_params:
            temperature: 0.2
          mode: chat
          name: gpt-4
          provider: langgenius/openai/openai
        prompt_template:
        - id: system-prompt
          role: system
          text: 'あなたは住宅ローン審査の専門家です。

            以下の基準で詳細評価を行ってください：


            【住宅ローン審査基準】

            1. 年収基準：年収400万円以上推奨

            2. 返済比率：年収の35%以内

            3. 勤続年数：2年以上推奨

            4. 年齢：借入時70歳未満、完済時80歳未満

            5. 雇用形態：正社員優遇

            6. 既存借入：年収の30%以内

            7. 担保価値：融資額の120%以上


            各項目を○/△/×で評価し、総合的な審査意見を述べてください。

            '
        - id: user-prompt
          role: user
          text: '【申込者情報】

            氏名: {{#data_extract_node.applicant_name#}}

            年齢: {{#data_extract_node.age#}}歳

            年収: {{#data_extract_node.annual_income#}}万円

            勤務先: {{#data_extract_node.employer#}}

            勤続年数: {{#data_extract_node.employment_years#}}年

            雇用形態: {{#data_extract_node.employment_type#}}

            既存借入: {{#data_extract_node.existing_debt#}}万円

            居住形態: {{#data_extract_node.housing_status#}}

            担保: {{#data_extract_node.collateral#}}


            【借入希望】

            希望額: {{#data_validation_node.loan_amount_processed#}}万円

            返済比率: {{#data_validation_node.payment_ratio#}}%


            【データ品質】

            品質: {{#data_validation_node.data_quality#}}

            リスク要因数: {{#data_validation_node.risk_count#}}個


            住宅ローン審査基準に基づいて詳細評価してください。

            '
        selected: false
        structured_output_enabled: false
        title: 住宅ローン審査
        type: llm
        variables: []
        vision:
          enabled: false
      height: 118
      id: housing_loan_analysis_node
      position:
        x: 1850
        y: 30
      positionAbsolute:
        x: 1850
        y: 30
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 自動車ローン専門審査
        model:
          completion_params:
            temperature: 0.2
          mode: chat
          name: gpt-4
          provider: langgenius/openai/openai
        prompt_template:
        - id: system-prompt
          role: system
          text: 'あなたは自動車ローン審査の専門家です。

            以下の基準で詳細評価を行ってください：


            【自動車ローン審査基準】

            1. 年収基準：年収200万円以上

            2. 返済比率：年収の30%以内

            3. 勤続年数：1年以上

            4. 年齢：借入時65歳未満、完済時70歳未満

            5. 雇用形態：安定収入重視

            6. 既存借入：年収の40%以内

            7. 車両価値：融資額の110%以上


            各項目を○/△/×で評価し、総合的な審査意見を述べてください。

            '
        - id: user-prompt
          role: user
          text: '【申込者情報】

            氏名: {{#data_extract_node.applicant_name#}}

            年齢: {{#data_extract_node.age#}}歳

            年収: {{#data_extract_node.annual_income#}}万円

            勤務先: {{#data_extract_node.employer#}}

            勤続年数: {{#data_extract_node.employment_years#}}年

            雇用形態: {{#data_extract_node.employment_type#}}

            既存借入: {{#data_extract_node.existing_debt#}}万円


            【借入希望】

            希望額: {{#data_validation_node.loan_amount_processed#}}万円

            返済比率: {{#data_validation_node.payment_ratio#}}%


            【データ品質】

            品質: {{#data_validation_node.data_quality#}}

            リスク要因数: {{#data_validation_node.risk_count#}}個


            自動車ローン審査基準に基づいて詳細評価してください。

            '
        selected: false
        structured_output_enabled: false
        title: 自動車ローン審査
        type: llm
        variables: []
        vision:
          enabled: false
      height: 118
      id: auto_loan_analysis_node
      position:
        x: 1850
        y: 150
      positionAbsolute:
        x: 1850
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 事業資金ローン専門審査
        model:
          completion_params:
            temperature: 0.2
          mode: chat
          name: gpt-4
          provider: langgenius/openai/openai
        prompt_template:
        - id: system-prompt
          role: system
          text: 'あなたは事業資金ローン審査の専門家です。

            以下の基準で詳細評価を行ってください：


            【事業資金ローン審査基準】

            1. 事業継続年数：3年以上推奨

            2. 年商基準：年商1000万円以上

            3. 利益率：売上の5%以上

            4. 自己資本比率：30%以上推奨

            5. 返済比率：月商の20%以内

            6. 事業計画の妥当性

            7. 担保・保証の充実度


            各項目を○/△/×で評価し、総合的な審査意見を述べてください。

            '
        - id: user-prompt
          role: user
          text: '【申込者情報】

            氏名: {{#data_extract_node.applicant_name#}}

            年齢: {{#data_extract_node.age#}}歳

            年収: {{#data_extract_node.annual_income#}}万円

            勤務先: {{#data_extract_node.employer#}}

            勤続年数: {{#data_extract_node.employment_years#}}年

            雇用形態: {{#data_extract_node.employment_type#}}

            既存借入: {{#data_extract_node.existing_debt#}}万円

            担保: {{#data_extract_node.collateral#}}


            【借入希望】

            希望額: {{#data_validation_node.loan_amount_processed#}}万円

            返済比率: {{#data_validation_node.payment_ratio#}}%


            【データ品質】

            品質: {{#data_validation_node.data_quality#}}

            リスク要因数: {{#data_validation_node.risk_count#}}個


            事業資金ローン審査基準に基づいて詳細評価してください。

            '
        selected: false
        structured_output_enabled: false
        title: 事業資金ローン審査
        type: llm
        variables: []
        vision:
          enabled: false
      height: 118
      id: business_loan_analysis_node
      position:
        x: 1850
        y: 270
      positionAbsolute:
        x: 1850
        y: 270
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "def main(analysis_text: str, annual_income: int, loan_amount_processed:\
          \ float,\n         age: int, employment_years: int, existing_debt: int,\
          \ \n         risk_count: int, loan_type: str) -> dict:\n    \"\"\"\n   \
          \ 信用スコア算出と最終判定\n    \"\"\"\n    import re\n    \n    # 基本スコア（100点満点）\n \
          \   base_score = 50\n    \n    # 年収スコア（20点満点）\n    if annual_income >= 800:\n\
          \        income_score = 20\n    elif annual_income >= 600:\n        income_score\
          \ = 18\n    elif annual_income >= 400:\n        income_score = 15\n    elif\
          \ annual_income >= 300:\n        income_score = 12\n    elif annual_income\
          \ >= 200:\n        income_score = 8\n    else:\n        income_score = 0\n\
          \    \n    # 年齢スコア（10点満点）\n    if 25 <= age <= 45:\n        age_score =\
          \ 10\n    elif 20 <= age <= 55:\n        age_score = 8\n    elif 18 <= age\
          \ <= 65:\n        age_score = 5\n    else:\n        age_score = 0\n    \n\
          \    # 勤続年数スコア（10点満点）\n    if employment_years >= 10:\n        employment_score\
          \ = 10\n    elif employment_years >= 5:\n        employment_score = 8\n\
          \    elif employment_years >= 2:\n        employment_score = 6\n    elif\
          \ employment_years >= 1:\n        employment_score = 3\n    else:\n    \
          \    employment_score = 0\n    \n    # 既存借入スコア（10点満点）\n    if existing_debt\
          \ == 0:\n        debt_score = 10\n    elif existing_debt <= annual_income\
          \ * 0.1:\n        debt_score = 8\n    elif existing_debt <= annual_income\
          \ * 0.3:\n        debt_score = 5\n    elif existing_debt <= annual_income\
          \ * 0.5:\n        debt_score = 2\n    else:\n        debt_score = 0\n  \
          \  \n    # 審査項目適合度スコア（評価結果から○/△/×をカウント）\n    good_count = len(re.findall(r'○',\
          \ analysis_text))\n    fair_count = len(re.findall(r'△', analysis_text))\n\
          \    poor_count = len(re.findall(r'×', analysis_text))\n    \n    total_items\
          \ = good_count + fair_count + poor_count\n    if total_items > 0:\n    \
          \    compliance_score = (good_count * 10 + fair_count * 5) / total_items\n\
          \    else:\n        compliance_score = 5\n    \n    # リスク減点\n    risk_penalty\
          \ = risk_count * 5\n    \n    # 総合スコア算出\n    total_score = (base_score +\
          \ income_score + age_score + \n                 employment_score + debt_score\
          \ + compliance_score - risk_penalty)\n    total_score = max(0, min(100,\
          \ total_score))  # 0-100に制限\n    \n    # ローン種別による最低基準調整\n    if loan_type\
          \ == \"住宅ローン\":\n        approval_threshold = 75\n        conditional_threshold\
          \ = 65\n    elif loan_type == \"自動車ローン\":\n        approval_threshold =\
          \ 70\n        conditional_threshold = 60\n    else:  # 事業資金ローン\n       \
          \ approval_threshold = 80\n        conditional_threshold = 70\n    \n  \
          \  # 最終判定\n    if total_score >= approval_threshold:\n        decision =\
          \ \"承認\"\n        decision_code = \"approved\"\n    elif total_score >=\
          \ conditional_threshold:\n        decision = \"条件付承認\"\n        decision_code\
          \ = \"conditional\"\n    else:\n        decision = \"否認\"\n        decision_code\
          \ = \"rejected\"\n    \n    # 推奨金利設定\n    if total_score >= 90:\n      \
          \  recommended_rate = 1.5\n    elif total_score >= 80:\n        recommended_rate\
          \ = 2.0\n    elif total_score >= 70:\n        recommended_rate = 2.5\n \
          \   elif total_score >= 60:\n        recommended_rate = 3.0\n    else:\n\
          \        recommended_rate = 3.5\n    \n    return {\n        \"total_score\"\
          : round(total_score, 1),\n        \"income_score\": income_score,\n    \
          \    \"age_score\": age_score,\n        \"employment_score\": employment_score,\n\
          \        \"debt_score\": debt_score,\n        \"compliance_score\": round(compliance_score,\
          \ 1),\n        \"risk_penalty\": risk_penalty,\n        \"decision\": decision,\n\
          \        \"decision_code\": decision_code,\n        \"recommended_rate\"\
          : recommended_rate,\n        \"good_items\": good_count,\n        \"fair_items\"\
          : fair_count,\n        \"poor_items\": poor_count\n    }\n"
        code_language: python3
        desc: 信用スコア算出と最終判定
        error_strategy: fail-branch
        outputs:
          age_score:
            children: null
            type: number
          compliance_score:
            children: null
            type: number
          debt_score:
            children: null
            type: number
          decision:
            children: null
            type: string
          decision_code:
            children: null
            type: string
          employment_score:
            children: null
            type: number
          fair_items:
            children: null
            type: number
          good_items:
            children: null
            type: number
          income_score:
            children: null
            type: number
          poor_items:
            children: null
            type: number
          recommended_rate:
            children: null
            type: number
          risk_penalty:
            children: null
            type: number
          total_score:
            children: null
            type: number
        selected: false
        title: 信用スコア算出
        type: code
        variables:
        - value_selector:
          - housing_loan_analysis_node
          - text
          variable: analysis_text
        - value_selector:
          - auto_loan_analysis_node
          - text
          variable: analysis_text
        - value_selector:
          - business_loan_analysis_node
          - text
          variable: analysis_text
        - value_selector:
          - data_extract_node
          - annual_income
          variable: annual_income
        - value_selector:
          - data_validation_node
          - loan_amount_processed
          variable: loan_amount_processed
        - value_selector:
          - data_extract_node
          - age
          variable: age
        - value_selector:
          - data_extract_node
          - employment_years
          variable: employment_years
        - value_selector:
          - data_extract_node
          - existing_debt
          variable: existing_debt
        - value_selector:
          - data_validation_node
          - risk_count
          variable: risk_count
        - value_selector:
          - start_node
          - loan_type
          variable: loan_type
      height: 118
      id: credit_scoring_node
      position:
        x: 2150
        y: 150
      positionAbsolute:
        x: 2150
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        cases:
        - case_id: approved
          conditions:
          - comparison_operator: is
            id: approved_condition
            value: approved
            varType: string
            variable_selector:
            - credit_scoring_node
            - decision_code
          id: approved
          logical_operator: and
        - case_id: conditional
          conditions:
          - comparison_operator: is
            id: conditional_condition
            value: conditional
            varType: string
            variable_selector:
            - credit_scoring_node
            - decision_code
          id: conditional
          logical_operator: and
        - case_id: rejected
          conditions:
          - comparison_operator: is
            id: rejected_condition
            value: rejected
            varType: string
            variable_selector:
            - credit_scoring_node
            - decision_code
          id: rejected
          logical_operator: and
        desc: 審査結果による最終レポート分岐
        selected: false
        title: 最終判定分岐
        type: if-else
      height: 250
      id: final_decision_node
      position:
        x: 2450
        y: 100
      positionAbsolute:
        x: 2450
        y: 100
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 承認時の詳細レポート生成
        model:
          completion_params:
            temperature: 0.3
          mode: chat
          name: gpt-4
          provider: langgenius/openai/openai
        prompt_template:
        - id: system-prompt
          role: system
          text: 'ローン承認時の正式レポートを作成してください。

            金融機関の承認通知書の形式で、明確で分かりやすい内容にしてください。

            '
        - id: user-prompt
          role: user
          text: '【審査結果】

            判定: {{#credit_scoring_node.decision#}}

            信用スコア: {{#credit_scoring_node.total_score#}}点/100点

            推奨金利: {{#credit_scoring_node.recommended_rate#}}%


            【申込者】

            氏名: {{#data_extract_node.applicant_name#}}

            年収: {{#data_extract_node.annual_income#}}万円

            借入希望額: {{#data_validation_node.loan_amount_processed#}}万円

            ローン種別: {{#start_node.loan_type#}}


            承認レポートを作成してください。融資条件、返済プラン、注意事項を含めてください。

            '
        selected: false
        structured_output_enabled: false
        title: 承認レポート生成
        type: llm
        variables: []
        vision:
          enabled: false
      height: 118
      id: approval_report_node
      position:
        x: 2750
        y: 30
      positionAbsolute:
        x: 2750
        y: 30
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 条件付承認時のレポート生成
        model:
          completion_params:
            temperature: 0.3
          mode: chat
          name: gpt-4
          provider: langgenius/openai/openai
        prompt_template:
        - id: system-prompt
          role: system
          text: 'ローン条件付承認時のレポートを作成してください。

            追加で必要な条件や書類を明確に示してください。

            '
        - id: user-prompt
          role: user
          text: '【審査結果】

            判定: {{#credit_scoring_node.decision#}}

            信用スコア: {{#credit_scoring_node.total_score#}}点/100点

            推奨金利: {{#credit_scoring_node.recommended_rate#}}%


            【申込者】

            氏名: {{#data_extract_node.applicant_name#}}

            年収: {{#data_extract_node.annual_income#}}万円

            借入希望額: {{#data_validation_node.loan_amount_processed#}}万円

            ローン種別: {{#start_node.loan_type#}}


            条件付承認レポートを作成してください。必要な追加条件、書類、期限を明記してください。

            '
        selected: false
        structured_output_enabled: false
        title: 条件付承認レポート生成
        type: llm
        variables: []
        vision:
          enabled: false
      height: 118
      id: conditional_report_node
      position:
        x: 2750
        y: 150
      positionAbsolute:
        x: 2750
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 否認時のレポート生成
        model:
          completion_params:
            temperature: 0.3
          mode: chat
          name: gpt-4
          provider: langgenius/openai/openai
        prompt_template:
        - id: system-prompt
          role: system
          text: 'ローン否認時のレポートを作成してください。

            否認理由を丁寧に説明し、今後の改善提案も含めてください。

            '
        - id: user-prompt
          role: user
          text: '【審査結果】

            判定: {{#credit_scoring_node.decision#}}

            信用スコア: {{#credit_scoring_node.total_score#}}点/100点


            【申込者】

            氏名: {{#data_extract_node.applicant_name#}}

            年収: {{#data_extract_node.annual_income#}}万円

            借入希望額: {{#data_validation_node.loan_amount_processed#}}万円

            ローン種別: {{#start_node.loan_type#}}


            【問題点】

            リスク要因: {{#data_validation_node.risk_factors#}}


            否認レポートを作成してください。具体的な理由と将来の再申請に向けた改善提案を含めてください。

            '
        selected: false
        structured_output_enabled: false
        title: 否認レポート生成
        type: llm
        variables: []
        vision:
          enabled: false
      height: 118
      id: rejection_report_node
      position:
        x: 2750
        y: 270
      positionAbsolute:
        x: 2750
        y: 270
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        answer: "## \U0001F4B3 ローン審査結果通知書\n\n**\U0001F3AF 審査結果: {{#credit_scoring_node.decision#}}**\n\
          **\U0001F4CA 信用スコア: {{#credit_scoring_node.total_score#}}点/100点満点**\n**\U0001F4B0\
          \ 推奨金利: {{#credit_scoring_node.recommended_rate#}}%**\n\n### \U0001F4CB\
          \ 申込概要\n- **申込者**: {{#data_extract_node.applicant_name#}} 様\n- **ローン種別**:\
          \ {{#start_node.loan_type#}}\n- **希望借入額**: {{#data_validation_node.loan_amount_processed#}}万円\n\
          - **年収**: {{#data_extract_node.annual_income#}}万円\n\n### \U0001F4CA 詳細スコア内訳\n\
          - \U0001F4B0 年収評価: {{#credit_scoring_node.income_score#}}点/20点\n- \U0001F464\
          \ 年齢評価: {{#credit_scoring_node.age_score#}}点/10点  \n- \U0001F3E2 勤続評価: {{#credit_scoring_node.employment_score#}}点/10点\n\
          - \U0001F4B3 借入状況: {{#credit_scoring_node.debt_score#}}点/10点\n- ✅ 適合度評価:\
          \ {{#credit_scoring_node.compliance_score#}}点/10点\n- ⚠️ リスク減点: -{{#credit_scoring_node.risk_penalty#}}点\n\
          \n### \U0001F4C8 審査項目評価\n- ✅ 適合項目: {{#credit_scoring_node.good_items#}}項目\n\
          - ⚠️ 要注意項目: {{#credit_scoring_node.fair_items#}}項目\n- ❌ 不適合項目: {{#credit_scoring_node.poor_items#}}項目\n\
          \n---\n\n{{#approval_report_node.text#}}{{#conditional_report_node.text#}}{{#rejection_report_node.text#}}\n\
          \n---\n\n### \U0001F504 審査実行フロー\n✅ 申込書ファイル形式判定・読み取り  \n✅ OCR/文書抽出による情報構造化\
          \  \n✅ Python検証による数値整合性チェック  \n✅ ローン種別による専門審査分岐  \n✅ 多項目信用スコア自動算出  \n✅ 承認/条件付/否認の3段階判定\
          \  \n✅ 結果別詳細レポート生成完了  \n\n### \U0001F4CA データ品質確認\n- **抽出品質**: {{#data_validation_node.data_quality#}}\n\
          - **検証エラー**: {{#data_validation_node.error_count#}}件\n- **リスク要因**: {{#data_validation_node.risk_count#}}件\n\
          \n*本審査は自動システムによる予備判定です。最終決定は人的審査を経て行われます*\n"
        desc: ''
        selected: false
        title: 審査結果通知書
        type: answer
        variables: []
      height: 984
      id: final_answer_node
      position:
        x: 3050
        y: 150
      positionAbsolute:
        x: 3050
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    viewport:
      x: 311.00309601807817
      y: 517.8542302389501
      zoom: 0.2503468139278337
