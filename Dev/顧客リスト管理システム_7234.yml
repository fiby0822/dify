app:
  description: "Googleスプレッドシートの「顧客リスト」シートで顧客データを管理するシステム。確認・追加・更新の3つの操作モードに対応。"
  icon: "📋"
  icon_background: "#FFEAD5"
  mode: advanced-chat
  name: "顧客リスト管理システム"
  use_icon_as_answer_icon: false

dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: omluc/google_sheets:0.0.2@17f06eaa1d905595e1a76460e7249707a722142353d551cf14aed3d8517c134f

kind: app
version: 0.3.0

workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      enabled: false
    opening_statement: |
      顧客リスト管理システムへようこそ！
      
      以下の操作モードから選択してください：
      - check: 現在の顧客リストを確認
      - add: 新規顧客を追加
      - update: 既存顧客のステータスを更新
      
      必要な情報：
      - GoogleスプレッドシートのURL
      - 操作モード（check/add/update）
      - 追加・更新時は顧客情報
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions:
      - "現在の顧客リストを確認したい"
      - "新規顧客「山田商事」を追加（案件：システム開発、金額：500万円、ステータス：商談中）"
      - "既存顧客「田中工業」のステータスを「受注」に更新"
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ""
      voice: ""
  graph:
    edges:
      - data:
          isInLoop: false
          sourceType: start
          targetType: llm
        id: start-llm-edge
        selected: false
        source: start_node
        sourceHandle: source
        target: parse_input_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: llm
          targetType: if-else
        id: llm-mode-edge
        selected: false
        source: parse_input_node
        sourceHandle: source
        target: mode_branch_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: if-else
          targetType: tool
        id: mode-check-edge
        selected: false
        source: mode_branch_node
        sourceHandle: check_mode
        target: batch_get_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: if-else
          targetType: tool
        id: mode-add-getcount-edge
        selected: false
        source: mode_branch_node
        sourceHandle: add_mode
        target: get_count_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: if-else
          targetType: tool
        id: mode-update-getdata-edge
        selected: false
        source: mode_branch_node
        sourceHandle: update_mode
        target: get_update_data_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: if-else
          targetType: answer
        id: mode-error-edge
        selected: false
        source: mode_branch_node
        sourceHandle: "false"
        target: error_answer_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: tool
          targetType: template-transform
        id: check-format-edge
        selected: false
        source: batch_get_node
        sourceHandle: source
        target: format_list_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: template-transform
          targetType: answer
        id: format-answer-edge
        selected: false
        source: format_list_node
        sourceHandle: source
        target: check_answer_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: tool
          targetType: template-transform
        id: getcount-prepare-edge
        selected: false
        source: get_count_node
        sourceHandle: source
        target: prepare_add_data_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: template-transform
          targetType: tool
        id: prepare-add-edge
        selected: false
        source: prepare_add_data_node
        sourceHandle: source
        target: batch_update_add_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: tool
          targetType: answer
        id: add-answer-edge
        selected: false
        source: batch_update_add_node
        sourceHandle: source
        target: add_answer_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: tool
          targetType: llm
        id: getupdate-find-edge
        selected: false
        source: get_update_data_node
        sourceHandle: source
        target: find_customer_row_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: llm
          targetType: template-transform
        id: find-prepareupdate-edge
        selected: false
        source: find_customer_row_node
        sourceHandle: source
        target: prepare_update_data_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: template-transform
          targetType: tool
        id: prepareupdate-update-edge
        selected: false
        source: prepare_update_data_node
        sourceHandle: source
        target: batch_update_status_node
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInLoop: false
          sourceType: tool
          targetType: answer
        id: update-answer-edge
        selected: false
        source: batch_update_status_node
        sourceHandle: source
        target: update_answer_node
        targetHandle: target
        type: custom
        zIndex: 0
    nodes:
      - data:
          desc: "開始ノード"
          selected: false
          title: "開始"
          type: start
          variables: []
        height: 54
        id: start_node
        position:
          x: 50
          y: 300
        positionAbsolute:
          x: 50
          y: 300
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          context:
            enabled: false
            variable_selector: []
          completion_params:
            frequency_penalty: 0
            max_tokens: 1000
            presence_penalty: 0
            temperature: 0.7
            top_p: 0.9
          desc: "ユーザー入力を解析して操作モードと必要情報を抽出"
          model:
            mode: chat
            name: gpt-3.5-turbo
            provider: openai
          prompt_template:
            - id: "system_prompt"
              role: system
              text: |
                あなたは顧客リスト管理システムの入力解析担当です。
                ユーザーの入力から以下の情報を抽出してください：
                
                1. operation_mode: check、add、updateのいずれか
                2. sheet_url: GoogleスプレッドシートのURL
                3. customer_name: 顧客名（追加・更新時）
                4. project_name: 案件名（追加時）
                5. amount: 金額（追加時）
                6. status: ステータス（追加・更新時）
                
                必ず以下の形式で出力してください：
                operation_mode: [モード]
                sheet_url: [URL]
                spreadsheet_id: [スプレッドシートID]
                customer_name: [顧客名]
                project_name: [案件名]
                amount: [金額]
                status: [ステータス]
                
                注意：URLから「/d/」と「/edit」の間にあるスプレッドシートIDを抽出してください。
            - id: "user_prompt"
              role: user
              text: "{{#sys.query#}}"
          selected: false
          structured_output_enabled: false
          title: "入力解析"
          type: llm
          variables: []
          vision:
            enabled: false
        height: 98
        id: parse_input_node
        position:
          x: 350
          y: 300
        positionAbsolute:
          x: 350
          y: 300
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          cases:
            - id: check_mode
              case_id: check_mode
              conditions:
                - variable_selector:
                    - parse_input_node
                    - text
                  comparison_operator: contains
                  value: "operation_mode: check"
              logical_operator: and
            - id: add_mode
              case_id: add_mode
              conditions:
                - variable_selector:
                    - parse_input_node
                    - text
                  comparison_operator: contains
                  value: "operation_mode: add"
              logical_operator: and
            - id: update_mode
              case_id: update_mode
              conditions:
                - variable_selector:
                    - parse_input_node
                    - text
                  comparison_operator: contains
                  value: "operation_mode: update"
              logical_operator: and
          desc: "操作モードによる分岐"
          selected: false
          title: "モード判定"
          type: if-else
        height: 154
        id: mode_branch_node
        position:
          x: 650
          y: 300
        positionAbsolute:
          x: 650
          y: 300
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          desc: ''
          is_team_authorization: true
          provider_id: omluc/google_sheets/google_sheets
          provider_name: omluc/google_sheets/google_sheets
          provider_type: builtin
          selected: false
          title: "顧客リスト取得"
          tool_configurations:
            date_time_render_option: FORMATTED_STRING
            major_dimension: null
            value_render_option: null
          tool_label: Batch Get
          tool_name: batch_get
          tool_parameters:
            ranges:
              type: mixed
              value: '["顧客リスト!A1:D100"]'
            spreadsheet_id:
              type: mixed
              value: "{{#parse_input_node.text|regex_search('spreadsheet_id: ([^\\n]+)')|first#}}"
          type: tool
        height: 102
        id: batch_get_node
        position:
          x: 950
          y: 100
        positionAbsolute:
          x: 950
          y: 100
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          selected: false
          template: |
            現在の顧客リスト：
            
            {% if sheet_data and sheet_data[0] and sheet_data[0]["valueRanges"] and sheet_data[0]["valueRanges"][0] and sheet_data[0]["valueRanges"][0]["values"] %}
            {% set values = sheet_data[0]["valueRanges"][0]["values"] %}
            登録顧客数：{{ values|length - 1 }}件
            
            {% for row in values %}
            {% if loop.index0 == 0 %}
            {{ row|join(' | ') }}
            ==============================
            {% else %}
            {{ loop.index }}. {{ row|join(' | ') }}
            {% endif %}
            {% endfor %}
            {% else %}
            データが見つかりませんでした。
            {% endif %}
          title: "リスト整形"
          type: template-transform
          variables:
            - value_selector:
                - batch_get_node
                - json
              value_type: array[object]
              variable: sheet_data
        height: 54
        id: format_list_node
        position:
          x: 1250
          y: 100
        positionAbsolute:
          x: 1250
          y: 100
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          answer: "{{#format_list_node.output#}}"
          desc: "顧客リスト確認結果"
          selected: false
          title: "確認結果表示"
          type: answer
          variables: []
        height: 107
        id: check_answer_node
        position:
          x: 1550
          y: 100
        positionAbsolute:
          x: 1550
          y: 100
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          desc: ''
          is_team_authorization: true
          provider_id: omluc/google_sheets/google_sheets
          provider_name: omluc/google_sheets/google_sheets
          provider_type: builtin
          selected: false
          title: "行数取得"
          tool_configurations:
            date_time_render_option: FORMATTED_STRING
            major_dimension: null
            value_render_option: null
          tool_label: Batch Get
          tool_name: batch_get
          tool_parameters:
            ranges:
              type: mixed
              value: '["顧客リスト!A:A"]'
            spreadsheet_id:
              type: mixed
              value: "{{#parse_input_node.text|regex_search('spreadsheet_id: ([^\\n]+)')|first#}}"
          type: tool
        height: 102
        id: get_count_node
        position:
          x: 950
          y: 300
        positionAbsolute:
          x: 950
          y: 300
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          selected: false
          template: |
            {% set customer_name = input_text|regex_search('customer_name: ([^\\n]+)')|first|default('') %}
            {% set project_name = input_text|regex_search('project_name: ([^\\n]+)')|first|default('') %}
            {% set amount = input_text|regex_search('amount: ([^\\n]+)')|first|default('') %}
            {% set status = input_text|regex_search('status: ([^\\n]+)')|first|default('') %}
            {% if count_data and count_data[0] and count_data[0]["valueRanges"] and count_data[0]["valueRanges"][0] and count_data[0]["valueRanges"][0]["values"] %}
            {% set row_num = count_data[0]["valueRanges"][0]["values"]|length + 1 %}
            [{
              "range": "顧客リスト!A{{ row_num }}:D{{ row_num }}",
              "values": [[
                {{ customer_name|default('')|tojson }},
                {{ project_name|default('')|tojson }},
                {{ amount|default('')|tojson }},
                {{ status|default('')|tojson }}
              ]]
            }]
            {% else %}
            [{
              "range": "顧客リスト!A2:D2",
              "values": [[
                {{ customer_name|default('')|tojson }},
                {{ project_name|default('')|tojson }},
                {{ amount|default('')|tojson }},
                {{ status|default('')|tojson }}
              ]]
            }]
            {% endif %}
          title: "追加データ準備"
          type: template-transform
          variables:
            - value_selector:
                - get_count_node
                - json
              value_type: array[object]
              variable: count_data
            - value_selector:
                - parse_input_node
                - text
              value_type: string
              variable: input_text
        height: 54
        id: prepare_add_data_node
        position:
          x: 1250
          y: 300
        positionAbsolute:
          x: 1250
          y: 300
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          desc: ''
          is_team_authorization: true
          provider_id: omluc/google_sheets/google_sheets
          provider_name: omluc/google_sheets/google_sheets
          provider_type: builtin
          selected: false
          title: "顧客追加"
          tool_configurations:
            include_values_in_response: null
            response_date_time_render_option: null
            response_value_render_option: null
            value_input_option: USER_ENTERED
          tool_label: Batch Update
          tool_name: batch_update
          tool_parameters:
            data:
              type: mixed
              value: "{{#prepare_add_data_node.output#}}"
            spreadsheet_id:
              type: mixed
              value: "{{#parse_input_node.text|regex_search('spreadsheet_id: ([^\\n]+)')|first#}}"
          type: tool
        height: 102
        id: batch_update_add_node
        position:
          x: 1550
          y: 300
        positionAbsolute:
          x: 1550
          y: 300
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          answer: "新規顧客を正常に追加しました。"
          desc: "追加完了メッセージ"
          selected: false
          title: "追加完了"
          type: answer
          variables: []
        height: 107
        id: add_answer_node
        position:
          x: 1850
          y: 300
        positionAbsolute:
          x: 1850
          y: 300
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          desc: ''
          is_team_authorization: true
          provider_id: omluc/google_sheets/google_sheets
          provider_name: omluc/google_sheets/google_sheets
          provider_type: builtin
          selected: false
          title: "更新対象取得"
          tool_configurations:
            date_time_render_option: FORMATTED_STRING
            major_dimension: null
            value_render_option: null
          tool_label: Batch Get
          tool_name: batch_get
          tool_parameters:
            ranges:
              type: mixed
              value: '["顧客リスト!A:D"]'
            spreadsheet_id:
              type: mixed
              value: "{{#parse_input_node.text|regex_search('spreadsheet_id: ([^\\n]+)')|first#}}"
          type: tool
        height: 102
        id: get_update_data_node
        position:
          x: 950
          y: 500
        positionAbsolute:
          x: 950
          y: 500
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          context:
            enabled: false
            variable_selector: []
          completion_params:
            frequency_penalty: 0
            max_tokens: 500
            presence_penalty: 0
            temperature: 0.3
            top_p: 0.9
          desc: "顧客名から行番号を特定"
          model:
            mode: chat
            name: gpt-3.5-turbo
            provider: openai
          prompt_template:
            - id: "system_prompt_find"
              role: system
              text: |
                顧客リストから指定された顧客名の行番号を見つけてください。
                
                入力情報から顧客名を抽出し、リストの何行目にあるか特定してください。
                必ず以下の形式で出力：
                row_number: [行番号]
                
                注意：ヘッダー行は1行目とカウントし、実際のデータ行は2行目から始まります。
            - id: "user_prompt_find"
              role: user
              text: |
                入力情報：
                {{#parse_input_node.text#}}
                
                顧客リスト：
                {{#get_update_data_node.json[0]["valueRanges"][0]["values"]#}}
          selected: false
          structured_output_enabled: false
          title: "行番号特定"
          type: llm
          variables: []
          vision:
            enabled: false
        height: 98
        id: find_customer_row_node
        position:
          x: 1250
          y: 500
        positionAbsolute:
          x: 1250
          y: 500
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          selected: false
          template: |
            {% set row_text = row_info|regex_search('row_number: ([^\\n]+)')|first|default('2') %}
            {% set new_status = input_info|regex_search('status: ([^\\n]+)')|first|default('') %}
            [{
              "range": "顧客リスト!D{{ row_text|default('2') }}",
              "values": [[{{ new_status|default('')|tojson }}]]
            }]
          title: "更新データ準備"
          type: template-transform
          variables:
            - value_selector:
                - find_customer_row_node
                - text
              value_type: string
              variable: row_info
            - value_selector:
                - parse_input_node
                - text
              value_type: string
              variable: input_info
        height: 54
        id: prepare_update_data_node
        position:
          x: 1550
          y: 500
        positionAbsolute:
          x: 1550
          y: 500
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          desc: ''
          is_team_authorization: true
          provider_id: omluc/google_sheets/google_sheets
          provider_name: omluc/google_sheets/google_sheets
          provider_type: builtin
          selected: false
          title: "ステータス更新"
          tool_configurations:
            include_values_in_response: null
            response_date_time_render_option: null
            response_value_render_option: null
            value_input_option: USER_ENTERED
          tool_label: Batch Update
          tool_name: batch_update
          tool_parameters:
            data:
              type: mixed
              value: "{{#prepare_update_data_node.output#}}"
            spreadsheet_id:
              type: mixed
              value: "{{#parse_input_node.text|regex_search('spreadsheet_id: ([^\\n]+)')|first#}}"
          type: tool
        height: 102
        id: batch_update_status_node
        position:
          x: 1850
          y: 500
        positionAbsolute:
          x: 1850
          y: 500
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          answer: "顧客のステータスを正常に更新しました。"
          desc: "更新完了メッセージ"
          selected: false
          title: "更新完了"
          type: answer
          variables: []
        height: 107
        id: update_answer_node
        position:
          x: 2150
          y: 500
        positionAbsolute:
          x: 2150
          y: 500
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          answer: "エラー：操作モードが認識できませんでした。check、add、updateのいずれかを指定してください。"
          desc: "エラーメッセージ"
          selected: false
          title: "エラー表示"
          type: answer
          variables: []
        height: 107
        id: error_answer_node
        position:
          x: 950
          y: 700
        positionAbsolute:
          x: 950
          y: 700
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
    viewport:
      x: 0
      y: 0
      zoom: 0.8